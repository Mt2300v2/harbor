<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP Update -->
     <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com;
        font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
        img-src 'self' data: file:;
        connect-src 'self';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <title>Steam Clone - Stylish Local</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* --- STYLISH DARK THEME --- */
        :root {
            --font-primary: 'Poppins', sans-serif;
            --bg-deep-dark: #0d1117; --bg-dark: #161b22; --bg-mid: #1c2128; --bg-light: #21262d;
            --bg-glass: rgba(22, 27, 34, 0.75); --bg-glass-light: rgba(33, 38, 45, 0.85); --backdrop-blur: 10px;
            --border-color-strong: #414a53; --border-color-subtle: #30363d;
            --text-primary: #c9d1d9; --text-secondary: #8b949e; --text-tertiary: #6d7681; --text-link: #58a6ff; --text-link-hover: #79c0ff;
            --accent-primary: #4b8ff7; --accent-primary-hover: #58a6ff; --accent-secondary: #3a8ad8;
            --accent-play: #3fb950; --accent-play-hover: #4bcd64;
            --accent-download: var(--accent-primary); --accent-download-hover: var(--accent-primary-hover);
            --accent-danger: #f85149; --accent-danger-hover: #da3633;
            --status-downloading: var(--accent-secondary); --status-installed: var(--text-secondary); --status-uninstalled: var(--text-tertiary);
            --chart-game: var(--accent-primary); --chart-other: var(--border-color-strong); --chart-free: var(--bg-dark);
            --shadow-elevation-low: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-elevation-medium: 0 4px 10px rgba(0, 0, 0, 0.25); --shadow-elevation-high: 0 8px 25px rgba(0, 0, 0, 0.35);
            --transition-speed-fast: 0.15s; --transition-speed-normal: 0.25s; --transition-timing: ease-in-out;
            --transition-speed-view: 0.3s; /* Speed for view transitions */
            --transition-timing-view: ease-out; /* Timing for view transitions */
            --radius-small: 4px; --radius-medium: 8px; --radius-large: 12px; --radius-xlarge: 16px; --radius-full: 999px;
            --accent-primary-rgb: 75, 143, 247; --bg-glass-light-rgb: 33, 38, 45;
            --bg-deep-dark-rgb: 13, 17, 23;
            --store-content-width: 940px;
        }
        /* --- BASE & UTILITIES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; scrollbar-color: var(--border-color-strong) var(--bg-dark); }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); border-radius: var(--radius-medium); }
        ::-webkit-scrollbar-thumb { background-color: var(--border-color-strong); border-radius: var(--radius-medium); border: 2px solid var(--bg-dark); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--text-tertiary); }
        ::-webkit-scrollbar-corner { background: transparent; }
        body { font-family: var(--font-primary); background-color: var(--bg-deep-dark); color: var(--text-primary); font-size: 14px; font-weight: 400; line-height: 1.5; overflow: hidden; height: 100vh; display: flex; flex-direction: column; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .glass-pane { background-color: var(--bg-glass); backdrop-filter: blur(var(--backdrop-blur)); border: 1px solid var(--border-color-subtle); border-radius: var(--radius-medium); box-shadow: var(--shadow-elevation-medium); }
        .glass-pane-light { background-color: var(--bg-glass-light); backdrop-filter: blur(var(--backdrop-blur)); border: 1px solid var(--border-color-subtle); border-radius: var(--radius-medium); }
        .hidden { display: none !important; }
        .clearfix::after { content: ""; clear: both; display: table; }
        button, a, .store-game-capsule, .add-game-button, .featured-action button, .category-item, .nav-arrows i { cursor: pointer; }
        button:disabled, .add-to-library-btn:disabled, .nav-arrows i.disabled { cursor: not-allowed; opacity: 0.5; }
        * { user-select: none; -webkit-user-select: none; -ms-user-select: none; -moz-user-select: none; }
        input, textarea { user-select: text; -webkit-user-select: text; -ms-user-select: text; -moz-user-select: text; }

        /* --- LAYOUT & NAVIGATION --- */
        .top-bar { background-color: var(--bg-dark); border-bottom: 1px solid var(--border-color-subtle); padding: 0 20px; height: 40px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 100; }
        .top-bar .menu ul, .top-bar .user-area ul { list-style: none; display: flex; align-items: center; gap: 5px; }
        .top-bar .menu li, .top-bar .user-area li { color: var(--text-secondary); font-size: 13px; transition: color var(--transition-speed-fast) var(--transition-timing); cursor: default; padding: 5px 8px; border-radius: var(--radius-small); }
        .top-bar .menu li:hover:not(#steamMenuButton), .top-bar .user-area li:hover { color: var(--text-primary); background-color: rgba(255, 255, 255, 0.05); }
        #steamMenuButton { font-weight: 700; color: var(--text-primary); cursor: pointer; margin-right: 10px; background-color: transparent; border: 1px solid transparent; }
        #steamMenuButton:hover { background-color: var(--bg-mid); border: 1px solid var(--border-color-subtle); }
        #steamDropdownMenu { background-color: var(--bg-glass); backdrop-filter: blur(var(--backdrop-blur)); border: 1px solid var(--border-color-subtle); box-shadow: var(--shadow-elevation-high); display: none; position: absolute; top: calc(100% + 5px); left: 15px; min-width: 200px; z-index: 110; border-radius: var(--radius-medium); padding: 8px; overflow: hidden; }
        #steamDropdownMenu button { display: block; width: 100%; background: none; border: none; color: var(--text-secondary); padding: 10px 15px; text-align: left; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: var(--radius-small); transition: all var(--transition-speed-fast) var(--transition-timing); }
        #steamDropdownMenu button:hover { background-color: var(--accent-primary); color: white; transform: translateX(4px); }
        .user-area { display: flex; align-items: center; gap: 15px; }
        .user-area i { font-size: 18px; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; transition: all var(--transition-speed-normal) var(--transition-timing); background-color: transparent; /* Remove round highlighter */ }
        .user-area i:hover { background-color: var(--bg-mid); color: var(--text-primary); }
        .user-profile { display: flex; align-items: center; background-color: transparent; padding: 2px 8px 2px 4px; border-radius: var(--radius-medium); cursor: pointer; border: 1px solid transparent; transition: all var(--transition-speed-normal) var(--transition-timing); }
        .user-profile:hover { background-color: var(--bg-mid); border-color: var(--border-color-subtle); }
        .user-profile img#topBarAvatar { width: 28px; height: 28px; border-radius: 50%; margin-right: 8px; object-fit: cover; border: 1px solid var(--border-color-subtle); background-color: var(--bg-mid); }
        .user-profile span#topBarUsername { color: var(--text-primary); font-size: 13px; font-weight: 600; }
        .user-profile i { font-size: 10px; margin-left: 8px; color: var(--text-secondary); }
        .window-controls { margin-left: 10px; display: flex; gap: 5px;}
        .window-controls i { margin-left: 0; border-radius: var(--radius-medium);}
        .main-nav { background-color: var(--bg-dark); padding: 0 25px; display: flex; align-items: center; height: 55px; border-bottom: 1px solid var(--border-color-subtle); flex-shrink: 0; gap: 15px; }
        .main-nav .nav-arrows i { font-size: 18px; color: var(--text-tertiary); padding: 6px; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: var(--radius-medium); transition: all var(--transition-speed-fast) var(--transition-timing); background-color: transparent; }
        .main-nav .nav-arrows i:not(.disabled):hover { background-color: var(--bg-mid); color: var(--text-primary); }
        .main-nav .nav-arrows i.disabled { color: var (--border-color-strong); background-color: transparent; }
        .main-nav ul { list-style: none; display: flex; align-items: center; gap: 10px; margin-left: 5px; }
        .main-nav li { font-size: 15px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); padding: 8px 15px; border-radius: var(--radius-medium); cursor: pointer; position: relative; overflow: visible; letter-spacing: 0.5px; background-color: transparent; border: 1px solid transparent; box-shadow: none; transform: translateY(0); transition: color var(--transition-speed-normal) var(--transition-timing-view), background-color var(--transition-speed-normal) var(--transition-timing-view), transform var(--transition-speed-normal) var(--transition-timing-view), box-shadow var(--transition-speed-normal) var(--transition-timing-view), border-color var(--transition-speed-normal) var(--transition-timing-view); }
        .main-nav li::after { display: none; } /* Removed underline */
        .main-nav li:hover:not(.active) { color: var(--text-primary); background-color: var(--bg-light); border-color: var(--border-color-subtle); transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.25); }
        .main-nav li.active { background-color: var(--bg-mid); color: var(--text-primary); border-color: var(--border-color-strong); box-shadow: inset 1px 2px 3px rgba(0, 0, 0, 0.3), inset -1px -1px 1px rgba(255, 255, 255, 0.03); transform: translateY(1px); }
        .main-nav li:last-child { margin-left: auto; margin-right: 0; font-weight: 600; }
        .main-nav li:last-child:hover:not(.active) { color: var(--text-primary); background-color: var(--bg-light); border-color: var(--border-color-subtle); transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.25); }
        .main-nav li:last-child.active { background-color: var(--bg-mid); color: var(--text-primary); border-color: var(--border-color-strong); box-shadow: inset 1px 2px 3px rgba(0, 0, 0, 0.3), inset -1px -1px 1px rgba(255, 255, 255, 0.03); transform: translateY(1px); }
        .content-area-container { flex-grow: 1; height: calc(100vh - 40px - 55px - 45px); overflow: hidden; position: relative; background-color: var(--bg-deep-dark); }
        .bottom-bar { background-color: var(--bg-dark); height: 45px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; border-top: 1px solid var(--border-color-subtle); flex-shrink: 0; }
        .friends-chat button { background-color: var(--bg-mid); border: 1px solid var(--border-color-subtle); color: var(--text-secondary); padding: 6px 12px; border-radius: var(--radius-medium); cursor: pointer; display: flex; align-items: center; font-size: 12px; font-weight: 600; transition: all var(--transition-speed-normal) var(--transition-timing); }
        .friends-chat button i { margin-right: 8px; font-size: 14px; }
        .friends-chat button:hover { background-color: var(--bg-light); color: var (--text-primary); border-color: var(--border-color-strong); transform: translateY(-1px); }

        /* --- VIEW TRANSITION STYLES --- */
        .content-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(10px); transition: opacity var(--transition-speed-view) var(--transition-timing-view), transform var(--transition-speed-view) var(--transition-timing-view), visibility 0s var(--transition-speed-view) linear; }
        .content-view.is-visible { opacity: 1; visibility: visible; transform: translateY(0); transition-delay: 0s, 0s, 0s; }

        /* --- LIBRARY VIEW --- */
        .library-content-area { display: flex; }
        .left-sidebar { width: 260px; background-color: var(--bg-dark); padding: 15px 0; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; border-right: 1px solid var(--border-color-subtle); height: 100%; }
        /* (Rest of library sidebar styles...) */
        .sidebar-link, .sidebar-header { padding: 8px 20px; display: flex; align-items: center; cursor: pointer; color: var(--text-secondary); transition: all var(--transition-speed-fast) var(--transition-timing); }
        .sidebar-link:hover, .sidebar-header:hover { background-color: var(--bg-mid); color: var(--text-primary); }
        .sidebar-link.home-link { font-size: 16px; font-weight: 700; color: var(--text-primary); padding-top: 10px; padding-bottom: 15px; }
        .sidebar-header { font-size: 11px; text-transform: uppercase; font-weight: 600; color: var (--text-secondary); margin-top: 15px; justify-content: space-between; position: relative; }
        .search-bar { padding: 15px 20px; margin: 0; }
        .search-bar-container { position: relative; }
        .search-bar input { width: 100%; background-color: var(--bg-mid); border: 1px solid var(--border-color-subtle); border-radius: var (--radius-medium); padding: 8px 12px 8px 35px; color: var(--text-primary); font-size: 13px; outline: none; transition: all var(--transition-speed-normal) var(--transition-timing); border-radius: var(--radius-medium); }
        .search-bar input:focus { border-color: var(--accent-primary); background-color: var(--bg-dark); box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb, 75, 143, 247), 0.3); }
        .search-bar-container i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); font-size: 14px; }
        .game-list-header { font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; padding: 15px 20px 5px 20px; border-top: 1px solid var(--border-color-subtle); margin-top: 10px; }
        .game-list-header span { color: var(--text-tertiary); }
        .game-list { list-style: none; flex-grow: 1; padding: 5px 10px; margin: 0; }
        .game-list li { display: flex; align-items: center; padding: 8px 10px; cursor: pointer; border-left: 4px solid transparent; user-select: none; border-radius: var(--radius-medium); transition: all var(--transition-speed-fast) var(--transition-timing); margin-bottom: 4px; }
        .game-list li:hover { background-color: var(--bg-mid); }
        .game-list li.active { background: linear-gradient(90deg, rgba(var(--accent-primary-rgb), 0.25) 0%, rgba(var(--accent-primary-rgb), 0.05) 100%); border-left-color: var(--accent-primary); color: white; }
        .game-list li.active .game-status { color: var(--accent-primary); font-weight: 500; }
        .game-list li.active .game-name { color: white; font-weight: 600; }
        .game-icon { width: 36px; height: 36px; margin-right: 12px; flex-shrink: 0; object-fit: cover; border-radius: var(--radius-small); border: 1px solid var(--border-color-subtle); background-color: var(--bg-mid); }
        .game-info { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex-grow: 1; display: flex; flex-direction: column; }
        .game-name { display: block; color: var(--text-primary); font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .game-status { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
        .game-status.installed { color: var (--status-installed); }
        .game-status.downloading { color: var (--status-downloading); }
        .game-status.uninstalled { color: var (--status-uninstalled); }
        .add-game-button { background-color: var(--bg-glass-light); backdrop-filter: blur(5px); border: 1px solid var(--border-color-subtle); padding: 12px 15px; margin: 15px 20px 10px 20px; border-radius: var(--radius-medium); text-align: center; cursor: pointer; color: var(--text-secondary); font-weight: 600; font-size: 13px; margin-top: auto; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all var(--transition-speed-normal) var(--transition-timing); box-shadow: var(--shadow-elevation-low); }
        .add-game-button i { margin-right: 8px; }
        .add-game-button:hover { background-color: var(--bg-mid); color: var(--text-primary); border-color: var(--border-color-strong); transform: translateY(-1px); box-shadow: var(--shadow-elevation-medium); }
        .categories-menu { display: none; position: absolute; top: 100%; right: 0; width: 260px; background-color: var(--bg-dark); border: 1px solid var(--border-color-subtle); border-radius: var(--radius-medium); padding: 10px; z-index: 1000; box-shadow: var(--shadow-elevation-high); margin-top: 5px; }
        .categories-menu-header { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; border-bottom: 1px solid var(--border-color-subtle); margin-bottom: 10px; }
        .categories-menu-header h3 { color: var(--text-primary); font-size: 14px; font-weight: 600; }
        .categories-menu-header button { background: none; border: none; color: var (--text-tertiary); cursor: pointer; padding: 5px; }
        .categories-menu-header button:hover { color: var(--text-primary); }
        .categories-list { max-height: 300px; overflow-y: auto; }
        .category-item { display: flex; align-items: center; padding: 8px 10px; color: var(--text-secondary); cursor: pointer; border-radius: var(--radius-small); transition: all var(--transition-speed-fast) var(--transition-timing); }
        .category-item:hover { background-color: var(--bg-mid); color: var(--text-primary); }
        .category-item.active { background-color: rgba(var(--accent-primary-rgb), 0.2); color: var(--text-primary); }
        .category-item input[type="checkbox"] { margin-right: 10px; }
        .game-details-pane { display: flex; flex-direction: column; flex-grow: 1; background-color: var(--bg-deep-dark); overflow: auto; }
        /* (Rest of game details styles...) */
         .game-banner { height: 350px; background-color: var(--bg-dark); background-size: cover; background-position: center center; position: relative; flex-shrink: 0; border-radius: var(--radius-large) var(--radius-large) 0 0; overflow: hidden; filter: blur(1.5px); transform: scale(1.02); }
        .game-banner::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 200px; background: linear-gradient(to top, var(--bg-deep-dark) 30%, transparent 100%); }
        #gameLogoOverlay { position: absolute; left: 50px; bottom: 30px; transform: none; max-width: 300px; max-height: 120px; z-index: 1; object-fit: contain; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); }
        .game-actions-bar { background-color: var(--bg-glass); backdrop-filter: blur(var(--backdrop-blur)); border: 1px solid var(--border-color-subtle); box-shadow: var(--shadow-elevation-medium); border-radius: var(--radius-large); display: flex; align-items: center; padding: 15px 25px; margin: -60px 40px 20px 40px; position: relative; z-index: 2; flex-shrink: 0; gap: 15px; }
        .action-button { color: white; border: none; padding: 12px 40px; font-size: 18px; font-weight: 900; letter-spacing: 0.5px; border-radius: var(--radius-medium); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition-speed-normal) var(--transition-timing); flex-shrink: 0; text-transform: uppercase; box-shadow: var(--shadow-elevation-medium), inset 0 1px 1px rgba(255,255,255,0.1); min-width: 160px; }
        .action-button i { margin-right: 12px; font-size: 20px; }
        .play-button { background: linear-gradient(to right, var(--accent-play), #2f8c4a); }
        .play-button:hover { background: linear-gradient(to right, var(--accent-play-hover), var(--accent-play)); transform: scale(1.03); box-shadow: var(--shadow-elevation-high), inset 0 1px 1px rgba(255,255,255,0.1); }
        .download-button { background: linear-gradient(to right, var(--accent-download), #2f6cb9); }
        .download-button:hover { background: linear-gradient(to right, var(--accent-download-hover), var(--accent-download)); transform: scale(1.03); box-shadow: var(--shadow-elevation-high), inset 0 1px 1px rgba(255,255,255,0.1); }
        .action-button:disabled { background: var(--border-color-strong) !important; color: var(--text-tertiary) !important; }
        .size-info-container { display: flex; align-items: center; position: relative; background-color: rgba(0,0,0,0.1); padding: 5px 10px; border-radius: var(--radius-small); margin-left: 5px; }
        #gameSizeLabel { font-size: 13px; color: var(--text-secondary); white-space: nowrap; margin-right: 8px; }
        #diskInfoIcon { color: var(--text-secondary); cursor: pointer; font-size: 14px; transition: color var(--transition-speed-fast) ease; }
        #diskInfoIcon:hover { color: var(--text-link-hover); }
        #diskInfoTooltip { background-color: var(--bg-glass-light); backdrop-filter: blur(var(--backdrop-blur)); border: 1px solid var(--border-color-strong); box-shadow: var(--shadow-elevation-high); display: none; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); width: 200px; border-radius: var(--radius-medium); padding: 12px; z-index: 50; color: var(--text-primary); font-size: 12px; text-align: center; }
        #diskInfoTooltip #diskInfoText { font-weight: 600; display: block; margin-bottom: 8px; }
        #diskInfoTooltip canvas { max-width: 100%; height: auto !important; }
        #diskInfoTooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: rgba(var(--bg-glass-light-rgb), 0.9) transparent transparent transparent; }
        #diskInfoLegend { margin-bottom: 10px; text-align: left; display: flex; flex-direction: column; gap: 4px; }
        .legend-item { display: flex; align-items: center; }
        .legend-color-box { width: 12px; height: 12px; margin-right: 6px; display: inline-block; border-radius: 2px; border: 1px solid rgba(0,0,0,0.2); }
        .legend-label { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 11px; color: var(--text-secondary); }
        .download-status-container, .decompression-status-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; min-width: 200px; margin-left: 15px; padding: 5px 0; }
        .status-text { /* Renamed from .download-text for broader use */ font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; letter-spacing: 0.5px; display: flex; align-items: center; /* Align icon and text */ }
        .status-text.decompressing { font-size: 14px; /* Larger text */ font-weight: 700; color: var(--text-primary); /* Brighter text */ }
        .status-text .fa-spin { margin-left: 8px; /* Space between text and icon */ font-size: 16px; /* Icon size */ }
        .progress-bar-container { background-color: var(--bg-dark); border-radius: var (--radius-full); height: 8px; overflow: hidden; position: relative; margin-bottom: 3px; border: 1px solid var(--border-color-subtle); }
        .progress-bar-fill { background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary)); height: 100%; width: 0%; border-radius: var(--radius-full); transition: width 0.2s linear; }
        #downloadProgressText, #decompressionProgressText { font-size: 11px; font-weight: 600; color: var(--accent-secondary); text-align: right !important; }
        #decompressionProgressBar { /* Specific style for decompression bar if needed, e.g., different color */ background: linear-gradient(to right, var(--accent-play), #2f8c4a); }
        .download-summary { display: flex; align-items: center; cursor: pointer; gap: 10px; } /* In bottom bar */
        .download-summary img { width: 28px; height: 28px; border-radius: var(--radius-small); object-fit: cover; border: 1px solid var(--border-color-subtle); background-color: var(--bg-mid); }
        .download-summary .download-info span { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 500; }
        .download-summary .progress-bar-container { width: 180px; height: 6px; background-color: var(--bg-deep-dark); border-radius: var(--radius-full); border: 1px solid var(--border-color-subtle); }
        #bottomDownloadProgressFill { height: 100%; width: 0%; background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary)); border-radius: var(--radius-full); transition: width 0.2s linear; }
        .download-summary .percentage { font-size: 12px; color: var(--text-link); font-weight: 700; margin-left: 5px; }
        .game-metadata { display: flex; margin-left: auto; text-align: right; align-items: center; }
        .metadata-item { margin-left: 20px; }
        .metadata-label { font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; display: block; font-weight: 500; letter-spacing: 0.3px; }
        .metadata-value { font-size: 14px; color: var(--text-secondary); font-weight: 600; }
        .game-action-icons { display: flex; align-items: center; margin-left: 25px; gap: 8px; }
        .game-action-icons i { font-size: 18px; color: var(--text-tertiary); background-color: transparent; padding: 8px; border-radius: 50%; cursor: pointer; border: 1px solid transparent; transition: all var(--transition-speed-fast) var(--transition-timing); }
        .game-action-icons i:hover { background-color: var(--bg-mid); color: var(--text-primary); border-color: var(--border-color-subtle); }
        .game-sub-nav { padding: 0 40px; border-top: 1px solid var(--border-color-subtle); border-bottom: 1px solid var(--border-color-subtle); margin-top: 25px; flex-shrink: 0; background-color: var(--bg-dark); height: 45px; display: flex; align-items: center; }
        .game-sub-nav ul { list-style: none; display: flex; gap: 20px; }
        .game-sub-nav li { color: var(--text-secondary); cursor: pointer; font-size: 13px; font-weight: 600; transition: color var(--transition-speed-fast) var(--transition-timing); }
        .game-sub-nav li:hover { color: var(--text-primary); }
        .post-game-summary { padding: 25px 40px; flex-shrink: 0; }
        .post-game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .post-game-title { font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .post-game-header i { color: var(--text-tertiary); cursor: pointer; font-size: 14px; padding: 5px; border-radius: 50%; transition: all var(--transition-speed-fast) var(--transition-timing); }
        .post-game-header i:hover { color: var(--text-secondary); background-color: var(--bg-mid); }
        .post-game-content { background-color: var(--bg-mid); padding: 15px 20px; border-radius: var(--radius-medium); color: var(--text-secondary); flex-grow: 1; border: 1px solid var(--border-color-subtle); }

        /* --- STORE VIEW --- */
        #store-content-area { background: var(--bg-deep-dark); color: var(--text-primary); padding: 30px 0 50px 0; overflow-y: auto; }
        .store-home-container { max-width: calc(var(--store-content-width) + 60px); margin: 0 auto; padding: 0 30px; }
        .store-section-title { color: var(--text-primary); font-size: 18px; font-weight: 800; text-transform: uppercase; margin: 40px 0 20px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border-color-strong); letter-spacing: 1px; }
        .store-search-bar { margin: 0 auto; max-width: calc(var(--store-content-width) + 60px); padding: 0 30px; margin-bottom: 30px; }
        .store-search-container { background-color: var(--bg-dark); border: 1px solid var(--border-color-subtle); border-radius: var(--radius-medium); padding: 12px 15px; display: flex; align-items: center; }
        .store-search-container i { color: var(--text-tertiary); font-size: 16px; margin-right: 10px; }
        .store-search-container input { background: none; border: none; color: var(--text-primary); font-size: 14px; width: 100%; outline: none; }
        .store-search-container input::placeholder { color: var(--text-tertiary); }
        .store-featured-section { display: flex; gap: 20px; background: var(--bg-mid); padding: 20px; border-radius: var(--radius-large); margin-bottom: 40px; box-shadow: var(--shadow-elevation-medium); }
        .featured-image { flex: 1; border-radius: var(--radius-medium); overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: var(--bg-dark); }
        .featured-image img { width: 100%; height: auto; object-fit: cover; }
        .featured-details { flex: 1; display: flex; flex-direction: column; justify-content: space-between; color: var (--text-primary); }
        .featured-title { font-size: 24px; font-weight: 800; margin-bottom: 10px; }
        .featured-description { font-size: 14px; line-height: 1.5; margin-bottom: 15px; color: var (--text-secondary); }
        .featured-price { font-size: 18px; font-weight: 700; color: var (--accent-primary); }
        .featured-action { margin-top: 10px; }
        .featured-action button { background: var(--accent-play); color: white; border: none; padding: 10px 20px; font-size: 14px; font-weight: 700; border-radius: var (--radius-medium); cursor: pointer; transition: all 0.2s ease-out; }
        .featured-action button:hover { background: var (--accent-play-hover); transform: scale(1.05); }
        .store-game-grid { display: flex; flex-wrap: wrap; gap: 25px; }
        .store-game-capsule { flex: 1 1 calc(50% - 25px); display: flex; align-items: center; gap: 15px; padding: 15px; background-color: var(--bg-dark); border-radius: var (--radius-medium); overflow: hidden; text-decoration: none; color: var(--text-secondary); border: 1px solid var(--border-color-subtle); transition: all var(--transition-speed-normal) var(--transition-timing); box-shadow: var(--shadow-elevation-low); border-radius: var(--radius-medium); }
        .store-game-capsule:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-elevation-high); border-color: var(--accent-primary); background-color: var(--bg-mid); }
        .capsule-image { width: 150px; height: auto; object-fit: cover; border-radius: var(--radius-small); background-color: var(--bg-mid); }
        .capsule-info { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .capsule-name { color: var(--text-primary); font-size: 16px; font-weight: 600; margin-bottom: 6px; }
        .capsule-tags { font-size: 12px; color: var (--text-tertiary); display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .capsule-tag { background-color: rgba(var(--accent-primary-rgb), 0.1); color: var(--text-link); padding: 2px 6px; border-radius: var(--radius-small); }
        .capsule-info i.fa-arrow-right { align-self: flex-end; color: var(--text-tertiary); transition: color 0.2s ease; font-size: 14px; margin-top: auto;}
        .store-game-capsule:hover .capsule-info i.fa-arrow-right { color: var(--accent-primary); }
        .store-game-page { max-width: var(--store-content-width); margin: 0 auto; padding: 20px 15px; }
        .store-breadcrumbs { font-size: 12px; color: var (--text-secondary); margin-bottom: 15px; font-weight: 500; }
        .store-breadcrumbs a { color: var(--text-secondary); text-decoration: none; transition: color var(--transition-speed-fast) ease; }
        .store-breadcrumbs a:hover { color: var(--text-link-hover); text-decoration: underline; }
        .store-game-title { color: white; font-size: 34px; font-weight: 900; margin-bottom: 5px; letter-spacing: 0.5px; }
        .community-hub-btn { background-color: var(--bg-mid); color: var(--text-secondary); padding: 8px 15px; border-radius: var(--radius-medium); text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s ease; float: right; margin-top: -35px; position: relative; z-index: 5; border: 1px solid var(--border-color-subtle); }
        .community-hub-btn:hover { background-color: var(--accent-primary); color: white; border-color: var (--accent-primary); box-shadow: var(--shadow-elevation-low); }
        .store-upper-area { display: flex; gap: 25px; margin-top: 30px; position: relative; }
        .store-left-col { flex: 0 0 600px; min-width: 0; }
        .store-right-col { flex: 1; min-width: 0; }
        .store-media-carousel { background-color: #000; border-radius: var(--radius-medium); margin-bottom: 25px; border: 1px solid var(--border-color-subtle); overflow: hidden; }
        .main-media-display { width: 100%; height: 337px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: var(--bg-deep-dark); }
        .main-media-display img { max-width: 100%; max-height: 100%; display: block; object-fit: contain; background-color: var(--bg-dark); }
        #mainMediaVideo { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background-color: var(--bg-deep-dark); }
        #mainMediaVideo video { max-width: 100%; max-height: 100%; }
        .media-thumbnails { display: flex; align-items: center; /* Updated Padding */ padding: 8px 10px; /* Add top/bottom padding */ background: rgba(0,0,0,0.4); overflow: hidden; border-top: 1px solid var(--border-color-subtle); }
        .thumbnail-list-container { flex-grow: 1; overflow: hidden; margin: 0 8px; }
        .thumbnail-list { display: flex; /* Updated Gap */ gap: 12px; transition: transform 0.3s ease; }
        .thumbnail-item { width: 100px; height: 56px; cursor: pointer; border: 2px solid transparent; background-color: #000; position: relative; flex-shrink: 0; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: var(--radius-small); margin: 5px; /* Add space around each thumbnail */ }
        .thumbnail-item img { width: 100%; height: 100%; display: block; object-fit: cover; opacity: 0.7; transition: opacity 0.2s ease; background-color: var(--bg-dark); }
        .thumbnail-item.active, .thumbnail-item:hover { border-color: var(--accent-primary-hover); transform: scale(1.05); }
        .thumbnail-item.active img, .thumbnail-item:hover img { opacity: 1; }
        .thumb-nav { background-color: var(--bg-mid); color: var(--text-primary); border: 1px solid var(--border-color-subtle); border-radius: var(--radius-medium); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-speed-fast) var (--transition-timing); font-size: 18px; }
        .thumb-nav:hover { background-color: var (--accent-primary); color: white; border-color: var (--accent-primary); transform: scale(1.1); }
        .thumb-nav:disabled { background-color: var(--bg-dark); color: var(--text-tertiary); cursor: not-allowed; transform: none; opacity: 0.5; }
        .store-info-snippet { color: var(--text-secondary); }
        .snippet-capsule { display: block; width: 100%; margin-bottom: 20px; border-radius: var (--radius-medium); box-shadow: var(--shadow-elevation-medium); border: 1px solid var(--border-color-subtle); background-color: var(--bg-mid); }
        .snippet-description { font-size: 14px; line-height: 1.7; margin-bottom: 20px; color: var(--text-primary); }
        .snippet-details { font-size: 12px; margin-bottom: 20px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--border-color-subtle); }
        .detail-row:last-child { border-bottom: none; }
        .detail-row span:first-child { color: var(--text-secondary); text-transform: uppercase; padding-right: 10px; font-weight: 600; letter-spacing: 0.3px; }
        .detail-row span:last-child { color: var(--text-primary); text-align: right; flex-shrink: 0; font-weight: 500; }
        .detail-row span a { color: var(--text-link); text-decoration: none; font-weight: 500; }
        .detail-row span a:hover { color: var(--text-link-hover); text-decoration: underline; }
        .snippet-tags { margin-top: 25px; }
        .snippet-tags strong { color: var(--text-secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 8px; letter-spacing: 0.5px; }
        .snippet-tags div { display: flex; flex-wrap: wrap; gap: 6px; }
        .store-tag { display: inline-block; background-color: var(--bg-mid); border: 1px solid var(--border-color-subtle); color: var(--text-secondary); padding: 4px 10px; border-radius: var(--radius-medium); font-size: 12px; font-weight: 500; cursor: pointer; text-decoration: none; transition: all var(--transition-speed-fast) ease; }
        .store-tag:hover { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); transform: scale(1.05); }
        .store-left-col-lower-content { background-color: var(--bg-glass); backdrop-filter: blur(var(--backdrop-blur)); border: 1px solid var(--border-color-subtle); box-shadow: var(--shadow-elevation-medium); border-radius: var(--radius-large); padding: 25px; margin-top: 25px; }
        .store-purchase-block { margin-bottom: 25px; }
        .store-purchase-block h2 { color: var(--text-primary); font-weight: 700; font-size: 18px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .buy-actions { display: flex; justify-content: flex-end; align-items: center; gap: 15px; background-color: var(--bg-dark); padding: 15px; border-radius: var(--radius-medium); border: 1px solid var(--border-color-subtle); }
        .price-area { color: var(--text-primary); font-size: 14px; text-align: right; }
        .price-area .current-price { font-size: 18px; font-weight: 700; }
        .add-to-library-btn { background: linear-gradient(to right, var(--accent-play), #2f8c4a); border: none; border-radius: var(--radius-medium); padding: 10px 25px; color: white; font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all .2s ease-out; flex-shrink: 0; box-shadow: var(--shadow-elevation-low); }
        .add-to-library-btn:hover { background: linear-gradient(to right, var(--accent-play-hover), var(--accent-play)); transform: scale(1.05); box-shadow: var(--shadow-elevation-medium); }
        .add-to-library-btn:disabled { background: var(--border-color-strong); color: var(--text-tertiary); }
        .store-features-list { font-size: 12px; color: var (--text-secondary); }
        .feature-item { display: flex; align-items: center; margin-bottom: 8px; background-color: rgba(0,0,0,0.2); padding: 8px 10px; border-radius: var(--radius-small); border: 1px solid transparent; transition: all 0.15s ease; }
        .feature-item:hover { border-color: var(--border-color-subtle); background-color: rgba(var(--accent-primary-rgb), 0.1); }
        .feature-item i { width: 20px; text-align: center; margin-right: 10px; color: var(--text-secondary); font-size: 16px; }
        .feature-item span { line-height: 1.4; font-weight: 500; color: var(--text-primary); }
        .store-system-requirements { margin-top: 20px; padding: 15px; background-color: var(--bg-mid); border-radius: var (--radius-medium); border: 1px solid var(--border-color-subtle); color: var(--text-primary); }
        .store-system-requirements h3 { font-size: 16px; font-weight: 700; margin-bottom: 10px; color: var(--text-primary); }
        .store-system-requirements pre { font-family: inherit; font-size: 13px; line-height: 1.6; white-space: pre-wrap; color: var(--text-secondary); background: none; border: none; padding: 0; }

        /* --- PROFILE VIEW --- */
        .profile-layout { display: flex; gap: 30px; max-width: 1100px; margin: 0 auto; padding: 30px 40px 50px 40px; height: 100%; overflow-y: auto; }
        .profile-left-col { flex: 0 0 250px; display: flex; flex-direction: column; align-items: center; }
        .profile-right-col { flex-grow: 1; }
        .profile-picture-container { width: 184px; height: 184px; border: 3px solid var(--border-color-strong); border-radius: var(--radius-medium); margin-bottom: 20px; position: relative; overflow: hidden; cursor: pointer; background-color: var(--bg-mid); display: flex; align-items: center; justify-content: center; }
        #profilePic { width: 100%; height: 100%; object-fit: cover; display: block; }
        #profilePic[src^="data:image/svg+xml"] { padding: 15px; object-fit: contain; background-color: var(--bg-mid); }
        #changePicButton { position: absolute; bottom: 0; left: 0; right: 0; background-color: rgba(0, 0, 0, 0.7); color: var(--text-primary); text-align: center; padding: 8px 0; font-size: 12px; font-weight: 600; opacity: 0; transition: opacity var(--transition-speed-fast) var(--transition-timing); border: none; cursor: pointer; }
        .profile-picture-container:hover #changePicButton { opacity: 1; }
        #profilePicInput { display: none; }
        .profile-username-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; min-height: 36px; }
        #profileUsername { font-size: 24px; font-weight: 700; color: var(--text-primary); text-align: center; }
        #editUsernameIcon { color: var(--text-secondary); cursor: pointer; font-size: 16px; padding: 5px; border-radius: 50%; transition: all var(--transition-speed-fast) var(--transition-timing); }
        #editUsernameIcon:hover { background-color: var(--bg-mid); color: var(--text-primary); }
        #editUsernameInput { font-size: 20px; font-weight: 700; color: var(--text-primary); background-color: var(--bg-mid); border: 1px solid var(--border-color-strong); padding: 5px 10px; border-radius: var(--radius-small); outline: none; text-align: center; width: 100%; max-width: 200px; }
        .profile-level { font-size: 14px; color: var(--text-secondary); text-align: center; margin-bottom: 20px; }
        .profile-section-title { font-size: 18px; font-weight: 700; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color-strong); }
        .expositor-section { margin-bottom: 30px; }
        #profileExpositors { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .expositor-box { position: relative; background-color: var(--bg-dark); border: 1px solid var(--border-color-subtle); border-radius: var (--radius-medium); padding: 15px; box-shadow: var(--shadow-elevation-low); transition: all var(--transition-speed-normal) var(--transition-timing); }
        .expositor-box:hover { transform: translateY(-3px); box-shadow: var(--shadow-elevation-medium); border-color: var(--border-color-strong); }
        .expositor-box:hover .delete-expositor-btn { opacity: 1; }
        .delete-expositor-btn { position: absolute; top: 8px; right: 8px; background-color: rgba(var(--bg-deep-dark-rgb), 0.6); color: var(--text-tertiary); border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity var(--transition-speed-fast), color var(--transition-speed-fast), background-color var(--transition-speed-fast); z-index: 5; }
        .delete-expositor-btn:hover { background-color: var(--accent-danger); color: white; }
        .expositor-image { display: block; max-width: 100%; height: auto; border-radius: var(--radius-small); margin-bottom: 10px; background-color: var(--bg-mid); border: 1px solid var(--border-color-subtle); }
        .expositor-box h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; }
        .expositor-box p { font-size: 13px; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap; }
        #addExpositorButton { background-color: var(--bg-mid); border: 1px solid var(--border-color-strong); color: var(--text-secondary); padding: 8px 15px; border-radius: var(--radius-medium); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; transition: all var(--transition-speed-normal) var(--transition-timing); margin-top: 20px; width: 100%; }
        #addExpositorButton i { margin-right: 8px; }
        #addExpositorButton:hover { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); }

        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity 0.2s ease-in-out, visibility 0s 0.2s linear; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out, visibility 0s 0s linear; }
        .modal-content { background-color: var(--bg-dark); padding: 25px 30px; border-radius: var(--radius-large); border: 1px solid var(--border-color-strong); box-shadow: var(--shadow-elevation-high); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { color: var(--text-primary); font-size: 18px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .modal-form-group { margin-bottom: 15px; }
        .modal-form-group label { display: block; color: var(--text-secondary); font-size: 12px; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; }
        .modal-form-group input[type="text"], .modal-form-group textarea { width: 100%; background-color: var(--bg-mid); border: 1px solid var(--border-color-subtle); border-radius: var(--radius-medium); padding: 10px 12px; color: var(--text-primary); font-size: 14px; outline: none; transition: all var(--transition-speed-normal) var(--transition-timing); }
        .modal-form-group textarea { min-height: 100px; resize: vertical; }
        .modal-form-group input[type="text"]:focus, .modal-form-group textarea:focus { border-color: var(--accent-primary); background-color: var(--bg-dark); box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.3); }
        .modal-form-group input[type="file"] { display: none; }
        .file-input-label { background-color: var(--bg-light); border: 1px dashed var(--border-color-strong); color: var(--text-secondary); padding: 10px 15px; border-radius: var(--radius-medium); display: inline-block; cursor: pointer; transition: all var(--transition-speed-normal); text-align: center; width: 100%; font-size: 13px; }
        .file-input-label:hover { background-color: var (--bg-mid); border-color: var (--accent-primary); color: var(--text-primary); }
        .file-input-label i { margin-right: 8px; }
        #expositorImagePreview { max-width: 100px; max-height: 100px; display: block; margin-top: 10px; border-radius: var (--radius-small); border: 1px solid var(--border-color-subtle); background-color: var(--bg-mid); object-fit: cover; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .modal-button { padding: 8px 20px; border-radius: var(--radius-medium); font-size: 14px; font-weight: 600; cursor: pointer; transition: all var(--transition-speed-normal) var(--transition-timing); border: 1px solid transparent; }
        .modal-button.primary { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        .modal-button.primary:hover { background-color: var(--accent-primary-hover); border-color: var (--accent-primary-hover); }
        .modal-button.secondary { background-color: var (--bg-mid); color: var(--text-secondary); border-color: var(--border-color-strong); }
        .modal-button.secondary:hover { background-color: var(--bg-light); color: var(--text-primary); border-color: var(--border-color-strong); }

    </style>
</head>
<body>
    <!-- HTML Structure (No changes) -->
    <div class="steam-client"> <header class="top-bar"> <div class="menu"> <ul> <li id="steamMenuButton">Steam</li> <li>View</li> <li>Friends</li> <li>Games</li> <li>Help</li> </ul> </div> <div class="user-area"> <ul> <li><i class="fas fa-volume-up"></i></li> <li><i class="fas fa-bell"></i></li> </ul> <div class="user-profile" id="topBarUserProfile"> <img src="" alt="User Avatar" id="topBarAvatar"> <span id="topBarUsername">Username</span> <i class="fas fa-chevron-down"></i> </div> <div class="window-controls"> <i class="far fa-window-minimize"></i> <i class="far fa-window-maximize"></i> <i class="fas fa-times"></i> </div> </div> <div id="steamDropdownMenu"> <button id="resetLibraryButton">Reset Library</button> </div> </header> <nav class="main-nav"> <div class="nav-arrows"> <i class="fas fa-chevron-left disabled" id="navBackArrow" title="Back"></i> <i class="fas fa-chevron-right disabled" id="navForwardArrow" title="Forward"></i> </div> <ul> <li id="nav-store" class="active">Store</li> <li id="nav-library">Library</li> <li id="nav-community">Community</li> <li id="nav-profile">Profile</li> </ul> </nav> <div class="content-area-container"> <div class="library-content-area content-view" id="library-content-area"> <aside class="left-sidebar"> <div class="sidebar-link home-link">HOME</div> <div class="sidebar-header"><span>Categories</span><div><i class="fas fa-bars"></i></div></div> <div class="search-bar"><div class="search-bar-container"><i class="fas fa-search"></i><input type="text" placeholder="Search Library"></div></div> <div class="game-list-header" id="libraryListHeader">LIBRARY <span id="gameCount">(0)</span></div> <ul class="game-list" id="gameList"></ul> <div class="add-game-button"><i class="fas fa-plus-circle"></i> Add a Game</div> </aside> <main class="game-details-pane"> <div class="game-banner" id="gameBanner"><img id="gameLogoOverlay" src="" alt="Game Logo"></div> <div class="game-actions-bar"> <button class="action-button hidden" id="actionButton"> <i class="" id="actionButtonIcon"></i> <span id="actionButtonText"></span> </button> <div class="size-info-container hidden" id="sizeInfoContainer"> <span id="gameSizeLabel"></span> <i class="fas fa-hdd" id="diskInfoIcon" title="Show disk usage"></i> <div id="diskInfoTooltip"> <span id="diskInfoText">Disk Usage</span> <div id="diskInfoLegend"> <div class="legend-item"><span class="legend-color-box" id="legend-color-game"></span><span class="legend-label" id="legend-label-game">Game</span></div> <div class="legend-item"><span class="legend-color-box" id="legend-color-other"></span><span class="legend-label" id="legend-label-other">Other</span></div> <div class="legend-item"><span class="legend-color-box" id="legend-color-free"></span><span class="legend-label" id="legend-label-free">Free</span></div> </div> <canvas id="diskUsageChartCanvas"></canvas> </div> </div> <div class="download-status-container hidden" id="downloadStatusContainer"> <div class="status-text" id="downloadTextLabel">DOWNLOADING</div> <div id="downloadProgressBarContainer" class="progress-bar-container"><div class="progress-bar-fill" id="downloadProgressBar"></div></div> <div class="status-text" id="downloadProgressText">0%</div> </div> <!-- Decompression Status Container --> <div class="decompression-status-container hidden" id="decompressionStatusContainer"> <div class="status-text decompressing" id="decompressionTextLabel">DECOMPRESSING...</div> <div id="decompressionProgressBarContainer" class="progress-bar-container"><div class="progress-bar-fill" id="decompressionProgressBar"></div></div> <div class="status-text" id="decompressionProgressText">0%</div> </div> <div class="game-metadata"> <div class="metadata-item"><span class="metadata-label">Last Played</span><span class="metadata-value" id="lastPlayedValue">-</span></div> <div class="metadata-item"><span class="metadata-label">Play Time</span><span class="metadata-value" id="playTimeValue">-</span></div> </div> <div class="game-action-icons"> <i class="fas fa-cog" title="Manage"></i> <i class="fas fa-info-circle" title="Game Info"></i> <i class="far fa-star" title="Favorite"></i> </div> </div> <nav class="game-sub-nav"> <ul><li>Store Page</li><li>Community Hub</li><li>Discussions</li><li>Guides</li><li>Support</li></ul> </nav> <section class="post-game-summary"> <div class="post-game-header"><span class="post-game-title">Post-Game</span><i class="fas fa-times"></i></div> <div class="post-game-content" id="postGameContent">Select game.</div> </section> </main> </div> <div id="store-content-area" class="content-view is-visible"> Loading Store... </div> <div class="profile-content-area content-view" id="profile-content-area"> <div class="profile-layout"> <div class="profile-left-col"> <div class="profile-picture-container" id="changePicContainer"> <img id="profilePic" src="" alt="Profile Picture"> <button id="changePicButton">Change Picture</button> </div> <input type="file" id="profilePicInput" accept="image/*"> <div class="profile-username-container"> <span id="profileUsername">Username</span> <input type="text" id="editUsernameInput" class="hidden"> <i class="fas fa-edit" id="editUsernameIcon"></i> </div> <div class="profile-level" id="profileLevelDisplay">Level 0</div> </div> <div class="profile-right-col"> <div class="expositor-section"> <h3 class="profile-section-title">Expositors</h3> <div id="profileExpositors"></div> <button id="addExpositorButton"><i class="fas fa-plus"></i> Add Expositor</button> </div> </div> </div> </div> </div> <footer class="bottom-bar" style="justify-content: center;"> <div class="download-summary hidden" id="bottomDownloadSummary"> <img id="bottomDownloadIcon" src="" alt="Downloading"> <div class="download-info"> <span id="bottomDownloadStatusText">Downloading</span> <div id="bottomDownloadBar" class="progress-bar-container" style="width: 400px; margin: 0 auto;"> <div class="progress-bar-fill" id="bottomDownloadProgressFill"></div> </div> <span class="percentage" id="bottomDownloadPercentage">0.00%</span> </div> <i class="fas fa-info-circle" id="downloadInfoIcon" title="Download Info"></i> </div> <div id="idleStatus" class="hidden" style="text-align: center; font-size: 14px; color: var(--text-secondary);"> Idle </div> <div id="torrentDetailsPanel" class="hidden glass-pane" style="position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); width: 400px; padding: 15px; z-index: 1000;"> <!-- Torrent details will be dynamically updated --> </div> <div style="flex-grow: 1;" id="bottomSpacer"></div> </footer> </div>
    <!-- Add Expositor Modal -->
    <div class="modal-overlay" id="addExpositorModal"> <div class="modal-content"> <h3>Add Expositor</h3> <div class="modal-form-group"> <label for="expositorTitleInput">Title</label> <input type="text" id="expositorTitleInput" placeholder="Title"> </div> <div class="modal-form-group"> <label for="expositorContentInput">Content</label> <textarea id="expositorContentInput" placeholder="Content..."></textarea> </div> <div class="modal-form-group"> <label for="expositorImageInput" class="file-input-label"> <i class="fas fa-image"></i> Add Image </label> <input type="file" id="expositorImageInput" accept="image/*"> <img id="expositorImagePreview" src="#" alt="Preview" class="hidden"> </div> <div class="modal-actions"> <button class="modal-button secondary" id="cancelExpositorButton">Cancel</button> <button class="modal-button primary" id="saveExpositorButton">Save</button> </div> </div> </div>
    <script>
        // Declare globally so functions outside DOMContentLoaded can use it
        var allGamesData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("[Renderer] DOM Loaded.");
            // Config & Constants
            const DEFAULT_AVATAR_SVG_STRING = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="#8b949e"><path d="M50 5a45 45 0 100 90 45 45 0 000-90zm0 16a18 18 0 110 36 18 18 0 010-36zm0 42c-15 0-28 7-35 18 7 11 20 18 35 18s28-7 35-18c-7-11-20-18-35-18z"/></svg>`;
            const DEFAULT_AVATAR_DATA_URI = `data:image/svg+xml;base64,${btoa(DEFAULT_AVATAR_SVG_STRING)}`;
            const VIEW_TRANSITION_DELAY = 50; // ms

            // --- Get Element References ---
             const libraryContentArea = document.getElementById('library-content-area');
             const storeContentArea = document.getElementById('store-content-area');
             const profileContentArea = document.getElementById('profile-content-area');
             const allContentViews = [libraryContentArea, storeContentArea, profileContentArea];
             const navStoreTab = document.getElementById('nav-store');
             const navLibraryTab = document.getElementById('nav-library');
             const navCommunityTab = document.getElementById('nav-community');
             const navProfileTab = document.getElementById('nav-profile');
             const navBackArrow = document.getElementById('navBackArrow');
             const navForwardArrow = document.getElementById('navForwardArrow');
             const allNavTabs = [navStoreTab, navLibraryTab, navCommunityTab, navProfileTab];
             const steamMenuButton = document.getElementById('steamMenuButton');
             const steamDropdownMenu = document.getElementById('steamDropdownMenu');
             const resetLibraryButton = document.getElementById('resetLibraryButton');
             const topBarUserProfile = document.getElementById('topBarUserProfile');
             const topBarAvatar = document.getElementById('topBarAvatar');
             const topBarUsername = document.getElementById('topBarUsername');
             const bottomDownloadSummaryElement = document.getElementById('bottomDownloadSummary');
             const bottomDownloadIconElement = document.getElementById('bottomDownloadIcon');
             const bottomDownloadProgressFillElement = document.getElementById('bottomDownloadProgressFill');
             const bottomDownloadPercentageElement = document.getElementById('bottomDownloadPercentage');
             const bottomDownloadStatusTextElement = document.getElementById('bottomDownloadStatusText');
             const bottomSpacerElement = document.getElementById('bottomSpacer');
             const gameListElement = document.getElementById('gameList');
             const gameBannerElement = document.getElementById('gameBanner');
             const gameLogoOverlayElement = document.getElementById('gameLogoOverlay');
             const actionButtonElement = document.getElementById('actionButton');
             const actionButtonIconElement = document.getElementById('actionButtonIcon');
             const actionButtonTextElement = document.getElementById('actionButtonText');
             const sizeInfoContainerElement = document.getElementById('sizeInfoContainer');
             const gameSizeLabelElement = document.getElementById('gameSizeLabel');
             const diskInfoIconElement = document.getElementById('diskInfoIcon');
             const diskInfoTooltipElement = document.getElementById('diskInfoTooltip');
             const diskUsageChartCanvasElement = document.getElementById('diskUsageChartCanvas');
             const diskInfoTextElement = document.getElementById('diskInfoText');
             const diskInfoLegendElement = document.getElementById('diskInfoLegend');
             const legendColorGame = document.getElementById('legend-color-game');
             const legendLabelGame = document.getElementById('legend-label-game');
             const legendColorOther = document.getElementById('legend-color-other');
             const legendLabelOther = document.getElementById('legend-label-other');
             const legendColorFree = document.getElementById('legend-color-free');
             const legendLabelFree = document.getElementById('legend-label-free');
             const downloadStatusContainerElement = document.getElementById('downloadStatusContainer');
             const downloadProgressBarElement = document.getElementById('downloadProgressBar');
             const downloadTextLabelElement = document.getElementById('downloadTextLabel');
             const downloadProgressTextElement = document.getElementById('downloadProgressText');
             const lastPlayedValueElement = document.getElementById('lastPlayedValue');
             const playTimeValueElement = document.getElementById('playTimeValue');
             const postGameContentElement = document.getElementById('postGameContent');
             const gameCountElement = document.getElementById('gameCount');
             const libraryListHeaderElement = document.getElementById('libraryListHeader');
             const searchBarInput = document.querySelector('.search-bar input');
             const sidebarHeader = document.querySelector('.sidebar-header');
             const categoryMenuIcon = sidebarHeader?.querySelector('i.fa-bars');
             const profilePicElement = document.getElementById('profilePic');
             const changePicContainer = document.getElementById('changePicContainer');
             const changePicButton = document.getElementById('changePicButton');
             const profilePicInputElement = document.getElementById('profilePicInput');
             const profileUsernameElement = document.getElementById('profileUsername');
             const editUsernameIcon = document.getElementById('editUsernameIcon');
             const editUsernameInputElement = document.getElementById('editUsernameInput');
             const profileLevelDisplay = document.getElementById('profileLevelDisplay');
             const profileExpositorsContainer = document.getElementById('profileExpositors');
             const addExpositorButton = document.getElementById('addExpositorButton');
             const addExpositorModal = document.getElementById('addExpositorModal');
             const expositorTitleInput = document.getElementById('expositorTitleInput');
             const expositorContentInput = document.getElementById('expositorContentInput');
             const expositorImageInput = document.getElementById('expositorImageInput');
             const expositorImagePreview = document.getElementById('expositorImagePreview');
             const saveExpositorButton = document.getElementById('saveExpositorButton');
             const cancelExpositorButton = document.getElementById('cancelExpositorButton');
             const diskUsageChartCanvas = diskUsageChartCanvasElement?.getContext('2d'); // Add safe access

            // --- State Variables ---
            let ownedGameIds = new Set(); let activeLibraryGameId = null; let currentStorePageId = null;
            let activeDownloadInterval = null; let currentlyDownloadingGameId = null; let currentDownloadProgress = 0;
            let diskUsageChart = null; let lastDiskInfo = null; let isFetchingDiskInfo = false;
            const chartColorGame = '#4b8ff7'; const chartColorOther = '#414a53'; const chartColorFree = '#161b22';
            let userProfileData = { name: "User", picture: DEFAULT_AVATAR_DATA_URI, level: 0, expositors: [] };
            let isEditingUsername = false;
            let activeCategories = new Set(); let allCategories = new Set(); let categoriesMenu = null;
            let currentExpositorImageDataUri = null;
            let navigationHistory = [];
            let currentHistoryIndex = -1;

            // --- Helper: Get Local Asset Path ---
             function getLocalAssetPath(originalUrl, gameId) { const placeholderIcon = './placeholder-icon.png'; const defaultAvatar = DEFAULT_AVATAR_DATA_URI; if (!originalUrl || typeof originalUrl !== 'string') return defaultAvatar; if (originalUrl.startsWith('data:')) return originalUrl; if (originalUrl.startsWith('assets/')) return `./${originalUrl}`; if (originalUrl.startsWith('./assets/')) return originalUrl; if (originalUrl.startsWith('http')) { try { const lastSlashIndex = originalUrl.lastIndexOf('/'); if (lastSlashIndex !== -1) { const filename = originalUrl.substring(lastSlashIndex + 1); if (filename && filename.includes('.')) return gameId ? `./assets/${gameId}/${filename}` : placeholderIcon; } } catch (e) { /* ignore */ } return gameId ? placeholderIcon : defaultAvatar; } return defaultAvatar; }

            // --- Helper Functions (Bytes) ---
            const GIB_BYTES = 1024*1024*1024; const MIB_BYTES = 1024*1024; const KIB_BYTES = 1024; const TIB_BYTES = GIB_BYTES*1024;
            function parseSizeToBytes(sizeString) { if (!sizeString) return 0; const m = sizeString.match(/([\d.,]+)\s*(\w+)/); if (!m) return 0; try { const v = parseFloat(m[1].replace(',','.')); const u = m[2].toUpperCase(); switch (u) { case 'TIB': case 'TB': return Math.round(v*TIB_BYTES); case 'GIB': case 'GB': return Math.round(v*GIB_BYTES); case 'MIB': case 'MB': return Math.round(v*MIB_BYTES); case 'KIB': case 'KB': return Math.round(v*KIB_BYTES); case 'B': return Math.round(v); default: return 0; } } catch(e) { console.error("Size parse error:", e); return 0; } }
            function formatBytes(bytes, d=1) { if (bytes==null||isNaN(bytes)||bytes<0) return 'N/A'; if (bytes === 0) return '0 Bytes'; const k = 1024; const dm = d < 0 ? 0 : d; const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); const idx = Math.min(i, sizes.length-1); const div = Math.pow(k, idx); if (div<=0) return 'N/A'; return `${parseFloat((bytes/div).toFixed(dm))} ${sizes[idx]}`; }

            // --- Profile Data Persistence ---
            async function loadProfileData() {
                const savedProfile = await window.electronAPI.loadProfile();
                userProfileData = savedProfile.user || { name: "User", picture: DEFAULT_AVATAR_DATA_URI, level: 0, expositors: [] };
                ownedGameIds = new Set(savedProfile.library.map(game => game.id));
                allGamesData.forEach(game => {
                    const savedGame = savedProfile.library.find(g => g.id === game.id);
                    if (savedGame) {
                        game.installedState = savedGame.installedState || 'uninstalled';
                        game.isOwned = true;
                        game.playtime = savedGame.playtime || 0; // Initialize playtime
                    } else {
                        game.playtime = 0; // Initialize playtime for unowned games
                    }
                });
                updateUserNameDisplay();
                updateProfilePictureDisplay();
                updateLevelDisplay();
            }

            function saveProfileData() {
                const profileData = {
                    user: userProfileData,
                    library: Array.from(ownedGameIds).map(id => {
                        const game = allGamesData.find(g => g.id === id);
                        // Ensure game exists before accessing properties
                        return game ? { id: game.id, installedState: game.installedState } : null;
                    }).filter(g => g !== null), // Filter out null entries if a game wasn't found
                };
                window.electronAPI.saveProfile(profileData);
            }

            // --- Profile Display & Update Functions ---
            function updateUserNameDisplay() { profileUsernameElement.textContent = userProfileData.name; editUsernameInputElement.value = userProfileData.name; topBarUsername.textContent = userProfileData.name; navProfileTab.textContent = userProfileData.name.toUpperCase(); }
            function updateLevelDisplay() { profileLevelDisplay.textContent = `Level ${userProfileData.level}`; }
            function updateProfilePictureDisplay() { const src = getLocalAssetPath(userProfileData.picture); profilePicElement.src = src; topBarAvatar.src = src; profilePicElement.onerror = ()=>{ profilePicElement.src = DEFAULT_AVATAR_DATA_URI; topBarAvatar.src = DEFAULT_AVATAR_DATA_URI; userProfileData.picture = DEFAULT_AVATAR_DATA_URI; saveProfileData(); }; topBarAvatar.onerror = ()=>{ topBarAvatar.src = DEFAULT_AVATAR_DATA_URI; }; }
            function renderExpositors() { profileExpositorsContainer.innerHTML = ''; const noExpoMsg = profileExpositorsContainer.querySelector('p.no-expositors'); if(noExpoMsg) noExpoMsg.remove(); if (userProfileData.expositors?.length > 0) { userProfileData.expositors.forEach(expo => { if (!expo || typeof expo.id === 'undefined') return; const div = document.createElement('div'); div.className = 'expositor-box'; const safeT = (expo.title||'').replace(/</g,"&lt;"); const safeC = (expo.content||'').replace(/</g,"&lt;"); const img = expo.image ? `<img class="expositor-image" src="${expo.image}" alt="">` : ''; div.innerHTML = `<button class="delete-expositor-btn" data-expositor-id="${expo.id}" title="Delete"><i class="fas fa-trash-alt"></i></button> ${img} <h4>${safeT}</h4> <p>${safeC}</p>`; profileExpositorsContainer.appendChild(div); }); } else { if (!profileExpositorsContainer.querySelector('p.no-expositors')) profileExpositorsContainer.innerHTML = '<p class="no-expositors" style="color:var(--text-tertiary);text-align:center;grid-column:1/-1;">No expositors.</p>'; } }
            function displayProfile() { updateUserNameDisplay(); updateProfilePictureDisplay(); updateLevelDisplay(); renderExpositors(); }

            // --- Update Playtime ---
            window.electronAPI.onUpdatePlaytime(async (event, data) => {
                const game = allGamesData.find(g => g.id === data.gameId);
                if (game) {
                    // Reload profile data
                    const savedProfile = await window.electronAPI.loadProfile();
                    const savedGame = savedProfile.library.find(g => g.id === data.gameId);
                    if (savedGame) {
                        game.playtime = savedGame.playtime || 0;
                    }

                    console.log('[Renderer] onUpdatePlaytime: gameId =', data.gameId, 'playtime =', game.playtime);
                    console.log('[Renderer] Calling displayLibraryGameDetails for game:', data.gameId);
                    displayLibraryGameDetails(game);
                }
            });

            // --- Fetch Game Data ---
            async function loadGameData() {
                 try {
                     // 1. Load the master game list from games.json (generated by scrape.py)
                     const r = await fetch('./games.json');
                     if (!r.ok) throw new Error(`HTTP ${r.status} fetching games.json`);
                     let gameList;
                     try {
                         gameList = await r.json();
                     } catch (e) {
                         throw new Error(`Parse error in games.json: ${e.message}`);
                     }
                     if (!Array.isArray(gameList)) {
                         // Provide a more helpful error if games.json isn't the expected array
                         console.error("Error: games.json content is not an array. Expected format: [{...}, {...}]");
                         console.error("Actual content snippet:", JSON.stringify(gameList).substring(0, 200));
                         throw new Error("games.json is not an array. Run scrape.py to generate game details.");
                     }
                     // Ensure allGamesData is declared or accessible in this scope
                     // If not declared globally, uncomment the next line:
                     // let allGamesData = [];
                     allGamesData = gameList; // Assign the master list

                     // Initialize default states - loadProfileData will override owned/installed status later
                     allGamesData.forEach((g) => {
                         if (!g?.id) return;
                         g.installedState = 'uninstalled'; // Default state
                         g.isOwned = false; // Default state
                         g.sizeBytes = parseSizeToBytes(g.downloadSize); // Pre-calculate bytes
                     });

                     // 2. Load user profile and library state (which updates allGamesData)
                     await loadProfileData(); // Ensure this runs AFTER allGamesData is populated

                     // 3. Continue with UI initialization using the merged data
                     createCategoriesMenu();
                     populateSidebar();
                     updateGlobalDownloadStatus();
                     navigateTo({ view: 'store' }); // Navigate to initial view

                 } catch (e) {
                     console.error("Game data loading sequence failed:", e);
                     // Display error messages in relevant UI areas
                     gameListElement.innerHTML = '<li>Error loading game data.</li>';
                     storeContentArea.innerHTML = '<p style="padding:20px; color:red;">Error loading game data. Check console (Ctrl+Shift+I) for details.</p>';
                     // Attempt to navigate somewhere safe, like library, even if data failed
                     navigateTo({ view: 'library' });
                 }
             }

            // --- Navigation & View Switching ---
            function updateNavigationArrows() { const canBack = currentHistoryIndex > 0; const canFwd = currentHistoryIndex < navigationHistory.length - 1; navBackArrow.classList.toggle('disabled', !canBack); navForwardArrow.classList.toggle('disabled', !canFwd); navBackArrow.disabled = !canBack; navForwardArrow.disabled = !canFwd; }
            function navigateTo(state, isHistoryNav = false) { if (!state?.view) { console.error("Invalid nav state:", state); return; } if (!isHistoryNav) { if (currentHistoryIndex < navigationHistory.length - 1) navigationHistory.length = currentHistoryIndex + 1; const last = navigationHistory[currentHistoryIndex]; if (!last || last.view !== state.view || last.id !== state.id) { navigationHistory.push(state); currentHistoryIndex++; } } _switchToViewInternal(state); updateNavigationArrows(); }
            function _switchToViewInternal(state) { const viewName = state.view; const itemId = state.id; allContentViews.forEach(view => view.classList.remove('is-visible')); if (viewName !== 'profile' && isEditingUsername) toggleUsernameEdit(false); setTimeout(() => { try { let targetView = null; allNavTabs.forEach(tab => tab?.classList.remove('active')); switch (viewName) { case 'library': targetView = libraryContentArea; navLibraryTab?.classList.add('active'); const targetId = itemId || activeLibraryGameId; if (targetId && ownedGameIds.has(targetId)) selectLibraryGame(targetId); else if (ownedGameIds.size > 0 && !activeLibraryGameId) selectLibraryGame(ownedGameIds.values().next().value); else if (activeLibraryGameId && ownedGameIds.has(activeLibraryGameId)) selectLibraryGame(activeLibraryGameId); else { displayEmptyLibraryDetails(); activeLibraryGameId = null; } currentStorePageId = null; break; case 'store': targetView = storeContentArea; navStoreTab?.classList.add('active'); if (itemId) { displayStoreGamePage(itemId); currentStorePageId = itemId; } else { displayStoreHomepage(); currentStorePageId = null; } activeLibraryGameId = null; break; case 'profile': targetView = profileContentArea; navProfileTab?.classList.add('active'); displayProfile(); activeLibraryGameId = null; currentStorePageId = null; break; case 'community': targetView = storeContentArea; navCommunityTab?.classList.add('active'); targetView.innerHTML = `<div style="padding:30px;text-align:center;"><p>${viewName} View</p></div>`; activeLibraryGameId = null; currentStorePageId = null; break; default: targetView = storeContentArea; targetView.innerHTML = `<p>Unknown view: ${viewName}</p>`; } targetView?.classList.add('is-visible'); } catch (e) { console.error(`Switch UI Error:`, e); storeContentArea.innerHTML = `<p>Error loading view.</p>`; storeContentArea.classList.add('is-visible'); } finally { steamDropdownMenu.style.display = 'none'; hideDiskUsageChart(); } }, VIEW_TRANSITION_DELAY); }

            // --- Library Functions ---
            function populateSidebar() { gameListElement.innerHTML = ''; gameCountElement.textContent = `(${ownedGameIds.size})`; if(ownedGameIds.size===0){ gameListElement.innerHTML='<li style="color:var(--text-tertiary);padding:10px;">No games.</li>'; filterLibraryByCategories(); return; } const games = []; ownedGameIds.forEach(id=>{const g=allGamesData.find(x=>x.id===id);if(g)games.push(g);}); games.sort((a,b)=>a.name.localeCompare(b.name)); games.forEach(g=>{const li=document.createElement('li');li.dataset.gameId=g.id; let sCls='',sTxt=''; switch(g.installedState){case 'installed': sCls='installed';sTxt='Installed';break; case 'downloading':sCls='downloading';sTxt='Downloading';break; default: sCls='uninstalled';sTxt='';} const icon=getLocalAssetPath(g.icon,g.id); li.innerHTML = `<img class="game-icon" src="${icon}" alt="${g.name}" onerror="this.alt='X'"><div class="game-info"><span class="game-name">${g.name}</span><span class="game-status ${sCls}">${sTxt}</span></div>`; li.onclick=()=>navigateTo({view:'library',id:g.id}); gameListElement.appendChild(li); }); if(activeLibraryGameId&&ownedGameIds.has(activeLibraryGameId)) gameListElement.querySelector(`li[data-game-id="${activeLibraryGameId}"]`)?.classList.add('active'); else if(games.length > 0 && !activeLibraryGameId){ activeLibraryGameId = games[0].id; gameListElement.querySelector(`li[data-game-id="${activeLibraryGameId}"]`)?.classList.add('active');} filterLibraryByCategories(); }
            function selectLibraryGame(gameId) { if (!ownedGameIds.has(gameId)) { console.warn(`Cannot select non-owned: ${gameId}`); displayEmptyLibraryDetails(); activeLibraryGameId=null; gameListElement.querySelectorAll('li').forEach(el => el.classList.remove('active')); return; } activeLibraryGameId=gameId; hideDiskUsageChart(); gameListElement.querySelectorAll('li').forEach(el => el.classList.toggle('active', el.dataset.gameId === gameId)); const game = allGamesData.find(g => g.id === gameId); if(game) displayLibraryGameDetails(game); else { console.error(`Data mismatch: ${gameId}`); displayEmptyLibraryDetails(); }}
            function displayLibraryGameDetails(game) {
    if (!game || !ownedGameIds.has(game.id)) {
        displayEmptyLibraryDetails();
        return;
    }
    try {
        const banner = getLocalAssetPath(game.banner, game.id);
        gameBannerElement.style.backgroundImage = `url('${banner}')`;
        gameBannerElement.style.backgroundColor = 'var(--bg-dark)';
        const logo = getLocalAssetPath(game.logo, game.id);
        gameLogoOverlayElement.src = logo;
        gameLogoOverlayElement.alt = game.logo ? `${game.name} Logo` : '';
        gameLogoOverlayElement.classList.toggle('hidden', !logo || logo === DEFAULT_AVATAR_DATA_URI || logo.includes('placeholder'));
        if (gameLogoOverlayElement.classList.contains('hidden')) gameLogoOverlayElement.src = '';
        lastPlayedValueElement.textContent = game.lastPlayed || '-';

        // Format playtime
        const playtimeSeconds = game.playtime || 0;
        const minutes = Math.floor(playtimeSeconds / 60);
        const seconds = playtimeSeconds % 60;
        const formattedPlaytime = `${minutes} minutes, ${seconds} seconds`;

        playTimeValueElement.textContent = formattedPlaytime;
        postGameContentElement.innerHTML = `Details for ${game.name}.`;
        actionButtonElement.classList.remove('play-button', 'download-button', 'hidden');
        actionButtonElement.onclick = null;
        actionButtonElement.disabled = false;
        sizeInfoContainerElement.classList.add('hidden');
        downloadStatusContainerElement.classList.add('hidden');
        /* Reset decompression styles first */
        downloadTextLabelElement.classList.remove('decompressing');
        const existingIcon = downloadTextLabelElement.querySelector('.fa-spin');
        if (existingIcon) existingIcon.remove();
        downloadProgressBarElement.classList.remove('hidden');
        downloadProgressTextElement.classList.remove('hidden');
        /* End Reset */
        if (game.installedState === 'installed') {
            actionButtonElement.classList.add('play-button');
            actionButtonIconElement.className = 'fas fa-play';
            actionButtonTextElement.textContent = 'PLAY';
            actionButtonElement.onclick = () => handlePlayButtonClick(game.id);
        } else if (game.installedState === 'downloading') {
            actionButtonElement.classList.add('hidden');
            downloadStatusContainerElement.classList.remove('hidden');
            downloadTextLabelElement.textContent = 'DOWNLOADING';
            downloadProgressBarElement.style.width = `${currentDownloadProgress}%`;
            downloadProgressTextElement.textContent = `${Math.floor(currentDownloadProgress)}%`;
        } else {
            sizeInfoContainerElement.classList.remove('hidden');
            actionButtonElement.classList.add('download-button');
            actionButtonIconElement.className = 'fas fa-download';
            actionButtonTextElement.textContent = 'DOWNLOAD';
            gameSizeLabelElement.textContent = `(${game.downloadSize || 'N/A'})`;
            actionButtonElement.disabled = (activeDownloadInterval !== null);
            actionButtonElement.onclick = () => {
                if (!activeDownloadInterval) startDownloadSimulation(game.id);
            };
        }
        updateSidebarItemStatus(game.id, game.installedState);
    } catch (e) {
        console.error("Details UI error:", e);
        postGameContentElement.innerHTML = '<span>Error</span>';
    }
}
            function displayEmptyLibraryDetails() { gameBannerElement.style.backgroundImage='none'; gameBannerElement.style.backgroundColor='var(--bg-dark)'; gameLogoOverlayElement.classList.add('hidden'); actionButtonElement.classList.add('hidden'); downloadStatusContainerElement.classList.add('hidden'); sizeInfoContainerElement.classList.add('hidden'); lastPlayedValueElement.textContent='-'; playTimeValueElement.textContent='-'; postGameContentElement.textContent='Select game.'; if(!libraryContentArea.classList.contains('is-visible')&&ownedGameIds.size === 0) postGameContentElement.textContent='Library empty.'; activeLibraryGameId=null; gameListElement.querySelectorAll('li').forEach(el => el.classList.remove('active')); hideDiskUsageChart(); } // Check is-visible instead of hidden
            function updateSidebarItemStatus(gameId, status) { const li=gameListElement.querySelector(`li[data-game-id="${gameId}"]`); if (!li) return; const se=li.querySelector('.game-status'); if (!se) return; se.className='game-status'; let txt='',cls=''; switch(status){ case 'installed': cls='installed';txt='Installed';break; case 'downloading': cls='downloading';txt='Downloading';break; default: cls='uninstalled';txt='';} se.classList.add(cls); se.textContent = txt; }
            function stopActiveDownload() { if(activeDownloadInterval){ clearInterval(activeDownloadInterval); activeDownloadInterval=null; const g = allGamesData.find(x => x.id===currentlyDownloadingGameId); if(g){g.installedState='uninstalled';updateSidebarItemStatus(g.id, g.installedState); if(activeLibraryGameId===g.id) displayLibraryGameDetails(g);} currentlyDownloadingGameId=null; currentDownloadProgress=0; updateGlobalDownloadStatus(); disableOtherDownloadButtons(false);}}

            let torrentDetails = {
                progress: 0,
                downloadSpeed: 0,
                uploaded: 0,
                peers: 0,
                totalSize: 0,
            };

            function startDownloadSimulation(gameId) {
                const game = allGamesData.find(x => x.id === gameId);
                if (!game || !ownedGameIds.has(gameId) || game.installedState !== 'uninstalled') return;

                if (game.source) {
                    console.log(`[Renderer] Starting torrent download for: ${game.source}`);
                    game.installedState = 'downloading';
                    currentlyDownloadingGameId = gameId;
                    currentDownloadProgress = 0;

                    // Update UI to reflect downloading state
                    updateSidebarItemStatus(gameId, 'downloading');
                    if (activeLibraryGameId === gameId) displayLibraryGameDetails(game);
                    updateGlobalDownloadStatus();

                    // Start torrent download
                    window.electronAPI.startTorrentDownload(game.source, gameId) // Ensure gameId is passed here
                        .then((result) => {
                            if (result.success) {
                                console.log(`[Renderer] Torrent download completed for: ${game.name}`);
                                game.installedState = 'installed';
                                // Clear download state
                                currentlyDownloadingGameId = null;
                                currentDownloadProgress = 0;
                                // Explicitly hide the download bar
                                const bottomDownloadSummary = document.getElementById('bottomDownloadSummary');
                                const idleStatus = document.getElementById('idleStatus');
                                // Removed hiding bottomDownloadSummary and idleStatus
                                populateSidebar();
                                // Add a check before calling displayLibraryGameDetails
                                if (game) {
                                    displayLibraryGameDetails(game);
                                } else {
                                    console.error("[Renderer] Game object became undefined before displaying details after download.");
                                }
                                updateGlobalDownloadStatus();
                                saveProfileData();
                            } else {
                                console.error(`[Renderer] Torrent download error: ${result.message}`);
                                alert(`Error: ${result.message}`);
                            }
                        })
                        .catch((err) => {
                            console.error(`[Renderer] Torrent download error: ${err.message}`);
                        });

                    // Listen for torrent progress updates
                    window.electronAPI.onTorrentProgress((event, data) => {
                        if (currentlyDownloadingGameId === gameId) {
                            currentDownloadProgress = parseFloat(data.progress);
                            updateGlobalDownloadStatus();

                            // Update progress bar in game details
                            if (activeLibraryGameId === gameId) {
                                downloadProgressBarElement.style.width = `${currentDownloadProgress}%`;
                                downloadProgressTextElement.textContent = `${Math.floor(currentDownloadProgress)}%`;
                            }

                            // Update detailed torrent info panel
                            torrentDetails = data;
                            updateTorrentDetailsPanel();
                        }
                });

                // Listen for decompression events
                window.electronAPI.onDecompressionProgress((event, data) => {
                    // Ensure the event is for the currently active game
                    if (currentlyDownloadingGameId === data.gameId) {
                        const percentage = data.progress;

                        // Update game details pane progress (if visible)
                        if (activeLibraryGameId === data.gameId) {
                            downloadProgressBarElement.style.width = `${percentage}%`;
                            downloadProgressTextElement.textContent = `${percentage}%`;
                            downloadTextLabelElement.textContent = 'DECOMPRESSING...';
                            // Ensure the container is visible during decompression
                            downloadStatusContainerElement.classList.remove('hidden');
                            actionButtonElement.classList.add('hidden'); // Hide action button
                            sizeInfoContainerElement.classList.add('hidden'); // Hide size info
                        }

                        // Update bottom bar progress
                        bottomDownloadSummaryElement.classList.remove('hidden');
                        bottomSpacerElement.classList.add('hidden');
                        bottomDownloadStatusTextElement.textContent = 'Decompressing';
                        bottomDownloadProgressFillElement.style.width = `${percentage}%`;
                        bottomDownloadPercentageElement.textContent = `${percentage}%`;
                        // Optionally change the bottom bar color for decompression
                        bottomDownloadProgressFillElement.style.background = 'linear-gradient(to right, var(--accent-play), #2f8c4a)';

                        // Update the global progress variable if needed, though it's mainly for torrents
                        // currentDownloadProgress = percentage;
                    }
                });

                window.electronAPI.onDecompressionComplete((event, data) => {
                    // Ensure the event is for the currently active game
                    if (currentlyDownloadingGameId === data.gameId) {
                        console.log(`[Renderer] Decompression completed for game ID: ${data.gameId}`);
                        const completedGame = allGamesData.find(g => g.id === data.gameId);

                        // Update game details pane UI (if visible)
                        if (activeLibraryGameId === data.gameId && completedGame) {
                             downloadTextLabelElement.textContent = 'DECOMPRESSION COMPLETE';
                             // Keep the status visible briefly or update to 'Installed' state later
                             // Maybe re-display the game details to show the PLAY button
                             displayLibraryGameDetails(completedGame);
                        }

                        // Reset bottom bar (will be handled by torrent completion logic setting installedState)
                        // Or explicitly hide if torrent logic doesn't cover this transition well
                        // updateGlobalDownloadStatus(); // This might hide it if currentlyDownloadingGameId is cleared too early

                         // Reset bottom bar progress fill color if changed
                         bottomDownloadProgressFillElement.style.background = 'linear-gradient(to right, var(--accent-secondary), var(--accent-primary))';
                    }
                });

                    return;
                }

                console.error(`[Renderer] No source found for game: ${game.name}`);
            }

            function updateTorrentDetailsPanel() {
                const panel = document.getElementById('torrentDetailsPanel');
                if (!panel) return;

                panel.innerHTML = `
                    <p><strong>Progress:</strong> ${torrentDetails.progress}%</p>
                    <p><strong>Download Speed:</strong> ${torrentDetails.downloadSpeed} KB/s</p>
                    <p><strong>Uploaded:</strong> ${torrentDetails.uploaded} MB</p>
                    <p><strong>Peers:</strong> ${torrentDetails.peers}</p>
                    <p><strong>Total Size:</strong> ${torrentDetails.totalSize} MB</p>
                `;
            }

             // --- Disk Usage Chart Logic ---
             async function showDiskUsageChart() { if (typeof window.electronAPI?.getDiskSpace !== 'function' || isFetchingDiskInfo) return; const game = allGamesData.find(g => g.id === activeLibraryGameId); if (!game || game.installedState !== 'uninstalled') { hideDiskUsageChart(); return; } diskInfoTooltipElement.style.display = 'block'; diskInfoTextElement.textContent='Loading...'; diskUsageChartCanvasElement.style.display='none'; diskInfoLegendElement.style.display='none'; if (diskUsageChart) {diskUsageChart.destroy(); diskUsageChart=null;} try { isFetchingDiskInfo = true; const info = lastDiskInfo || await window.electronAPI.getDiskSpace(); isFetchingDiskInfo = false; if (info?.free != null && info?.total != null) { lastDiskInfo=info; const total=info.total; const free=info.free; const gameBytes=game.sizeBytes; if(total<=0||gameBytes<0||free<0) throw new Error("Invalid size"); const used=Math.max(0,total-free); const other=Math.max(0,used); const freeAfter=Math.max(0,free-gameBytes); if(gameBytes > free){ diskInfoTextElement.textContent=`Need ${formatBytes(gameBytes - free)} more`; diskUsageChartCanvasElement.style.display = 'none'; diskInfoLegendElement.style.display = 'none'; return;} diskInfoTextElement.textContent=`Disk (${formatBytes(total)})`; diskUsageChartCanvasElement.style.display='block'; diskInfoLegendElement.style.display='flex'; legendColorGame.style.backgroundColor=chartColorGame; legendLabelGame.textContent=`Game (${formatBytes(gameBytes)})`; legendColorOther.style.backgroundColor=chartColorOther; legendLabelOther.textContent=`Other (${formatBytes(other)})`; legendColorFree.style.backgroundColor=chartColorFree; legendLabelFree.textContent=`Free (${formatBytes(freeAfter)})`; try{diskUsageChart=new Chart(diskUsageChartCanvas,{type:'pie',data:{datasets:[{data:[gameBytes,other,freeAfter],backgroundColor:[chartColorGame,chartColorOther,chartColorFree],borderColor:'#2a3a4f',borderWidth:1,hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:true,animation:{duration:300},plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>{let i=ctx.dataIndex; return i===0?legendLabelGame.textContent:i===1?legendLabelOther.textContent:legendLabelFree.textContent;}}}}}});}catch(e){console.error("Chart err:", e);diskInfoTextElement.textContent='Chart Error';}} else { console.error("Invalid disk info:", info); diskInfoTextElement.textContent = 'Disk Error'; } } catch (e) { console.error('Disk space err:', e); diskInfoTextElement.textContent='Error'; isFetchingDiskInfo=false;} }
             function hideDiskUsageChart() { diskInfoTooltipElement.style.display = 'none'; if (diskUsageChart) { diskUsageChart.destroy(); diskUsageChart = null; } }

            // --- Store Functions ---
            function displayStoreHomepage() {
                 currentStorePageId = null; const randomized = [...allGamesData].sort(()=>Math.random()-0.5); let featGame = randomized.find(g=>g.header) || (allGamesData.length > 0 ? randomized[0] : null); const otherGames = randomized.filter(g => g.capsule && g.id !== featGame?.id);
                 const searchHTML = `<div class="store-search-bar"><div class="store-search-container"><i class="fas fa-search"></i><input id="storeSearchInput" placeholder="Search"></div></div>`; let featHTML = '';
                 if (featGame) { const imgUrl=getLocalAssetPath(featGame.header,featGame.id); featHTML = `<h2>Featured</h2><div class="store-featured-section"><div class="featured-image"><img src="${imgUrl}" alt="${featGame.name}"></div><div class="featured-details"><div><h3>${featGame.name}</h3><p>${(featGame.description||'').substring(0,150)}...</p><span>${featGame.is_free?'Free':'19.99'}</span></div><div class="featured-action"><button class="featured-details-btn" data-game-id="${featGame.id}">Details</button></div></div></div>`;}
                 let gridHTML=''; if(otherGames.length > 0){ gridHTML+='<h2>More Games</h2><div class="store-game-grid">'; otherGames.forEach(g=>{const tags=g.tags?.slice(0,3).map(t=>`<span class="capsule-tag">${t}</span>`).join('')||''; const capUrl=getLocalAssetPath(g.capsule,g.id); gridHTML+=`<a class="store-game-capsule" data-game-id="${g.id}" href="#"><img class="capsule-image" src="${capUrl}" alt="${g.name}" loading="lazy"><div class="capsule-info"><div><span class="capsule-name">${g.name}</span><div class="capsule-tags">${tags}</div></div><i class="fas fa-arrow-right"></i></div></a>`;}); gridHTML+='</div>';}
                 storeContentArea.innerHTML = `<div class="store-home-container">${searchHTML}${featHTML}${gridHTML}</div>`;
                 // Add Listeners
                 storeContentArea.querySelector('.featured-details-btn')?.addEventListener('click',(e)=>navigateTo({view:'store',id:e.currentTarget.dataset.gameId}));
                 storeContentArea.querySelectorAll('.store-game-capsule').forEach(item=>item.addEventListener('click',(e)=>{e.preventDefault(); navigateTo({view:'store',id:item.dataset.gameId});}));
            }
             function displayStoreGamePage(gameId) {
                currentStorePageId = gameId; storeContentArea.scrollTo({top:0,behavior:'instant'}); const game=allGamesData.find(g=>g.id===gameId); if(!game){storeContentArea.innerHTML=`<p>Not found: ${gameId}</p>`; return;} const fmtDate=(d)=>{if(!d)return'?';try{return new Date(d).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'});}catch(e){return d;}}; const fIcon=(c)=>{const l=c.toLowerCase();if(l.includes('single'))return 'fa-user';if(l.includes('multi'))return 'fa-users';if(l.includes('co-op'))return 'fa-user-friends';if(l.includes('achieve'))return 'fa-trophy';return 'fa-info-circle';}; const pGenre = game.primary_genre?.split('(')[0].trim() || 'Games'; const crumbs = `<div class="store-breadcrumbs"><a href="#" onclick="event.preventDefault();navigateTo({view:'store'});">All</a> > <a href="#">${pGenre}</a> > ${game.name}</div>`; const title = `<div class="clearfix"><a href="#" class="community-hub-btn">Hub</a><h1 class="store-game-title">${game.name}</h1></div>`; let media=game.screenshots?.map(s=>({type:'image',src:getLocalAssetPath(s,game.id)}))||[]; let mainM=media.length>0?media[0].src:getLocalAssetPath(game.header,game.id); let thumbs=media.length>0?media.map((m,i)=>`<div class="thumbnail-item ${i===0?'active':''}" data-index="${i}"><img src="${m.src}" loading="lazy" alt="T${i+1}"></div>`).join(''):''; const carousel=`<div class="store-media-carousel"><div class="main-media-display"><img id="mainMediaImage" src="${mainM}"></div><div class="media-thumbnails"><button class="thumb-nav prev" id="thumbPrevBtn"><i class="fas fa-chevron-left"></i></button><div class="thumbnail-list-container"><div class="thumbnail-list" id="thumbnailList">${thumbs}</div></div><button class="thumb-nav next" id="thumbNextBtn"><i class="fas fa-chevron-right"></i></button></div></div>`; const tagsHTML=(game.tags?.map(t=>`<a href="#" class="store-tag">${t}</a>`).join('')||'')+'+'; const capPath=getLocalAssetPath(game.capsule,game.id); const snippet=`<div class="store-info-snippet"><img class="snippet-capsule" src="${capPath}"><p class="snippet-description">${game.description||''}</p><div class="snippet-details"><div class="detail-row"><span>Release:</span><span>${fmtDate(game.release_date)}</span></div><div class="detail-row"><span>Dev:</span><span>${game.developer||'?'}</span></div></div><div class="snippet-tags"><strong>Tags:</strong><div>${tagsHTML}</div></div></div>`; const isOwned=ownedGameIds.has(game.id); const btnTxt=isOwned?'In Lib':'Add'; const purchase=`<div class="store-purchase-block"><h2>Buy</h2><div class="buy-actions"><span>${game.is_free?'Free':'19.99'}</span><button class="add-to-library-btn" data-game-id="${game.id}" ${isOwned?'disabled':''}>${btnTxt}</button></div></div>`; let feats=game.categories?.map(c=>`<div class="feature-item"><i class="fas ${fIcon(c)}"></i><span>${c}</span></div>`).join('')||'None.'; const featList=`<div class="store-features-list">${feats}</div>`; const reqs=`<div class="store-system-requirements"><h3>Reqs</h3><pre><strong>Min:</strong>\n${game.pc_requirements?.minimum||'?'}</pre>${game.pc_requirements?.recommended?`<pre><strong>Rec:</strong>\n${game.pc_requirements.recommended}</pre>`:''}</div>`; storeContentArea.innerHTML=`<div class="store-game-page" data-game-page-id="${game.id}">${crumbs}${title}<div class="store-upper-area"><div class="store-left-col">${carousel}${purchase}${reqs}<div class="store-left-col-lower-content">${featList}</div></div><div class="store-right-col">${snippet}</div></div></div>`; const mainImg=storeContentArea.querySelector('#mainMediaImage'); const thumbItems=storeContentArea.querySelectorAll('.thumbnail-item'); thumbItems.forEach(t=>{t.onclick=()=>{thumbItems.forEach(th=>th.classList.remove('active'));t.classList.add('active'); const i=parseInt(t.dataset.index); const m=media[i]; if(m?.type==='image') mainImg.src=m.src;}}); const addBtn=storeContentArea.querySelector('.add-to-library-btn'); if(addBtn&&!isOwned)addBtn.onclick=handleAddToLibraryClick; const tList=storeContentArea.querySelector('#thumbnailList'); const pBtn=storeContentArea.querySelector('#thumbPrevBtn'); const nBtn=storeContentArea.querySelector('#thumbNextBtn'); setupThumbnailNavigation(tList,pBtn,nBtn);
            }

             function handleAddToLibraryClick(e) { const btn=e.target; const gid=btn.dataset.gameId; const g=allGamesData.find(x=>x.id===gid); if(!g || ownedGameIds.has(gid)) return; ownedGameIds.add(gid); g.isOwned=true; g.installedState='uninstalled'; btn.textContent='In Lib'; btn.disabled=true; populateSidebar(); saveProfileData(); }
             function updateGlobalDownloadStatus() { if(currentlyDownloadingGameId != null){ const g=allGamesData.find(x=>x.id===currentlyDownloadingGameId); if(g){ bottomDownloadSummaryElement.classList.remove('hidden'); bottomSpacerElement.classList.add('hidden'); const icon=getLocalAssetPath(g.icon, g.id); bottomDownloadIconElement.src = icon||''; bottomDownloadIconElement.onerror=()=>{bottomDownloadIconElement.alt='X';}; bottomDownloadStatusTextElement.textContent=`Downloading`; const p = Math.floor(currentDownloadProgress); bottomDownloadProgressFillElement.style.width=`${p}%`; bottomDownloadPercentageElement.textContent=`${p}%`; } else { bottomDownloadSummaryElement.classList.add('hidden'); bottomSpacerElement.classList.remove('hidden'); } } else { bottomDownloadSummaryElement.classList.add('hidden'); bottomSpacerElement.classList.remove('hidden'); } }
             function toggleSteamMenu() { steamDropdownMenu.style.display = steamDropdownMenu.style.display === 'block' ? 'none' : 'block'; }

             // --- Library Filtering / Categories ---
             function createCategoriesMenu() { categoriesMenu=document.createElement('div'); categoriesMenu.className='categories-menu'; categoriesMenu.innerHTML=`<div class="categories-menu-header"><h3>Filter</h3><button id="clearCategoriesBtn" title="Clear"><i class="fas fa-times"></i></button></div><div class="categories-list"></div>`; sidebarHeader.appendChild(categoriesMenu); categoriesMenu.querySelector('#clearCategoriesBtn')?.addEventListener('click',()=>{activeCategories.clear(); populateCategoriesMenu(); filterLibraryByCategories(); categoriesMenu.style.display='none';});}
             function collectAllCategories() { allCategories.clear(); ownedGameIds.forEach(id=>{const g=allGamesData.find(x=>x.id===id); g?.categories?.forEach(c=>allCategories.add(c));}); return Array.from(allCategories).sort(); }
             function populateCategoriesMenu() { if(!categoriesMenu) return; const list=categoriesMenu.querySelector('.categories-list'); if(!list) return; const cats = collectAllCategories(); if(cats.length===0){list.innerHTML='<p>No cats.</p>'; return;} list.innerHTML = cats.map(c => `<div class="category-item ${activeCategories.has(c)?'active':''}" data-category="${c}"><input type="checkbox" ${activeCategories.has(c)?'checked':''} style="pointer-events: none;"><span>${c}</span></div>`).join(''); list.querySelectorAll('.category-item').forEach(item => { item.onclick=()=>{const c=item.dataset.category; const cb=item.querySelector('input'); if(activeCategories.has(c)){activeCategories.delete(c); item.classList.remove('active'); cb.checked=false;}else{activeCategories.add(c); item.classList.add('active'); cb.checked=true;} filterLibraryByCategories();};}); }
             function filterLibraryByCategories() { const items = gameListElement.querySelectorAll('li[data-game-id]'); let count=0; const term=searchBarInput.value.toLowerCase(); items.forEach(item => { const gid = item.dataset.gameId; const g = allGamesData.find(x=>x.id===gid); let showCats = activeCategories.size === 0 || (g?.categories && g.categories.some(c=>activeCategories.has(c))); let showSearch = !term || g?.name?.toLowerCase().includes(term); item.style.display = showCats && showSearch ? '' : 'none'; if(showCats && showSearch) count++; }); libraryListHeaderElement.textContent = `LIBRARY (${count})`; }
             function toggleCategoriesMenu() { if(!categoriesMenu) return; const vis = categoriesMenu.style.display === 'block'; if(vis) categoriesMenu.style.display='none'; else { populateCategoriesMenu(); categoriesMenu.style.display='block'; }}

             // --- Thumbnail Navigation Helper ---
             function setupThumbnailNavigation(list, prev, next) { if (!list || !prev || !next) return; let scrollAmount = 0; const scrollStep = 220; const updateBtns = () => { const max = Math.max(0, list.scrollWidth - list.clientWidth); prev.disabled = scrollAmount <= 0; next.disabled = scrollAmount >= max; prev.classList.toggle('disabled', prev.disabled); next.classList.toggle('disabled', next.disabled);}; prev.onclick=()=>{ scrollAmount=Math.max(0,scrollAmount-scrollStep); list.style.transform=`translateX(-${scrollAmount}px)`; updateBtns(); }; next.onclick=()=>{ const max=list.scrollWidth - list.clientWidth; scrollAmount=Math.min(max,scrollAmount+scrollStep); list.style.transform=`translateX(-${scrollAmount}px)`; updateBtns(); }; setTimeout(updateBtns, 150);}

             // --- Event Listeners ---
             steamMenuButton.addEventListener('click', (e)=>{ e.stopPropagation(); toggleSteamMenu(); });
             window.addEventListener('click', (e) => { if (steamDropdownMenu.style.display==='block' && !steamDropdownMenu.contains(e.target) && e.target!==steamMenuButton) steamDropdownMenu.style.display = 'none'; });
             resetLibraryButton.addEventListener('click', () => { if (confirm('Reset library?')) { stopActiveDownload(); ownedGameIds.clear(); allGamesData.forEach(g=>{g.isOwned=false; g.installedState='uninstalled';}); populateSidebar(); activeLibraryGameId=null; navigationHistory=[]; currentHistoryIndex=-1; navigateTo({view:'library'}); saveProfileData(); } steamDropdownMenu.style.display='none'; });
             diskInfoIconElement?.addEventListener('mouseenter', showDiskUsageChart); // Safe access
             diskInfoIconElement?.addEventListener('mouseleave', hideDiskUsageChart); // Safe access
             searchBarInput.addEventListener('input', filterLibraryByCategories);
             categoryMenuIcon?.addEventListener('click', (e) => { e.stopPropagation(); toggleCategoriesMenu(); });
             document.addEventListener('click', (e) => { if (categoriesMenu?.style.display==='block' && !categoriesMenu.contains(e.target) && e.target !== categoryMenuIcon && !sidebarHeader.contains(e.target)) categoriesMenu.style.display = 'none'; });

             // Navigation
             navStoreTab?.addEventListener('click', () => navigateTo({ view: 'store' }));
             navLibraryTab?.addEventListener('click', () => navigateTo({ view: 'library', id: activeLibraryGameId || undefined }));
             navCommunityTab?.addEventListener('click', () => navigateTo({ view: 'community' }));
             navProfileTab?.addEventListener('click', () => navigateTo({ view: 'profile' }));
             topBarUserProfile?.addEventListener('click', () => navigateTo({ view: 'profile' }));
             navBackArrow.addEventListener('click', () => { if (currentHistoryIndex > 0) { currentHistoryIndex--; navigateTo(navigationHistory[currentHistoryIndex], true); }});
             navForwardArrow.addEventListener('click', () => { if (currentHistoryIndex < navigationHistory.length - 1) { currentHistoryIndex++; navigateTo(navigationHistory[currentHistoryIndex], true); }});

             // Profile
             changePicContainer.addEventListener('click', ()=>profilePicInputElement.click());
             changePicButton.addEventListener('click', (e)=>{ e.stopPropagation(); profilePicInputElement.click(); });
             profilePicInputElement.addEventListener('change',(e)=>{const f=e.target.files[0]; if(f?.type.startsWith('image/')){ const r=new FileReader();r.onload=(ev)=>{userProfileData.picture=ev.target.result;updateProfilePictureDisplay();saveProfileData();}; r.onerror=()=>alert("Read err.");r.readAsDataURL(f);}else if(f) alert("Bad image."); e.target.value=null;});
             editUsernameIcon.addEventListener('click',()=>toggleUsernameEdit(true));
             function toggleUsernameEdit(enable){ isEditingUsername=enable; profileUsernameElement.classList.toggle('hidden',enable); editUsernameIcon.classList.toggle('hidden',enable); editUsernameInputElement.classList.toggle('hidden',!enable); if(enable){editUsernameInputElement.value=userProfileData.name; editUsernameInputElement.focus(); editUsernameInputElement.select();}}
             editUsernameInputElement.addEventListener('blur', ()=>{ if(isEditingUsername){ const n=editUsernameInputElement.value.trim(); if(n&&n!==userProfileData.name){userProfileData.name=n; saveProfileData();}else{editUsernameInputElement.value=userProfileData.name;} updateUserNameDisplay(); toggleUsernameEdit(false);}});
             editUsernameInputElement.addEventListener('keydown', (e)=>{if(e.key==='Enter'){e.preventDefault(); editUsernameInputElement.blur();}else if(e.key==='Escape'){editUsernameInputElement.value=userProfileData.name; toggleUsernameEdit(false);}});
             profileExpositorsContainer.addEventListener('click',(e)=>{const btn=e.target.closest('.delete-expositor-btn'); if(btn){ const id=parseInt(btn.dataset.expositorId, 10); if(!isNaN(id)){ if(confirm('Delete?')){ const idx=userProfileData.expositors.findIndex(ex=>ex.id===id); if(idx>-1){ userProfileData.expositors.splice(idx,1); renderExpositors(); saveProfileData();}}} }});

             // Modal
             function showAddExpositorModal() { expositorTitleInput.value=''; expositorContentInput.value=''; expositorImageInput.value=null; expositorImagePreview.src='#'; expositorImagePreview.classList.add('hidden'); currentExpositorImageDataUri=null; addExpositorModal.classList.add('visible'); expositorTitleInput.focus();}
             function hideAddExpositorModal() { addExpositorModal.classList.remove('visible'); }
             addExpositorButton.addEventListener('click', showAddExpositorModal);
             cancelExpositorButton.addEventListener('click', hideAddExpositorModal);
             saveExpositorButton.addEventListener('click',()=>{ const title=expositorTitleInput.value.trim(); const content=expositorContentInput.value.trim(); if(!title){alert("Needs title."); return;} const expo = {id:Date.now(), title:title, content:content||"", image:currentExpositorImageDataUri}; if(!Array.isArray(userProfileData.expositors))userProfileData=[]; userProfileData.expositors.push(expo); renderExpositors(); saveProfileData(); hideAddExpositorModal();});
             addExpositorModal.addEventListener('click', (e)=>{ if(e.target===addExpositorModal) hideAddExpositorModal(); });
             expositorImageInput.addEventListener('change', (e)=>{ const f = e.target.files[0]; currentExpositorImageDataUri=null; expositorImagePreview.classList.add('hidden'); if(f?.type.startsWith('image/')){ const r = new FileReader(); r.onload=(ev)=>{currentExpositorImageDataUri=ev.target.result; expositorImagePreview.src=currentExpositorImageDataUri; expositorImagePreview.classList.remove('hidden');}; r.onerror=()=>{alert('Read error');currentExpositorImageDataUri=null; expositorImagePreview.classList.add('hidden'); e.target.value=null;}; r.readAsDataURL(f); } else if(f){ alert("Invalid image."); e.target.value=null;} });

            // --- Initialization ---
            // Initialization: Load game data first, which then loads profile data internally
            await loadGameData(); // This now handles the full sequence including loadProfileData
            updateNavigationArrows(); // Set initial arrow state
            console.log("[Renderer] Init complete.");

            // Fix window control buttons
            const minimizeButton = document.querySelector('.far.fa-window-minimize');
            const maximizeRestoreButton = document.querySelector('.far.fa-window-maximize');
            const closeButton = document.querySelector('.fas.fa-times');

            minimizeButton?.addEventListener('click', () => {
                window.electronAPI.minimizeWindow();
            });

            maximizeRestoreButton?.addEventListener('click', () => {
                window.electronAPI.maximizeRestoreWindow();
            });

            closeButton?.addEventListener('click', () => {
                window.electronAPI.closeWindow();
            });

            // Fix store search bar functionality
            const storeSearchInput = document.getElementById('storeSearchInput');
            storeSearchInput?.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const gameCards = document.querySelectorAll('.store-game-capsule');
                gameCards.forEach((card) => {
                    const gameName = card.querySelector('.capsule-name')?.textContent.toLowerCase();
                    card.style.display = gameName?.includes(term) ? '' : 'none';
                });
            });

            // Add "Reset Profile" button to Steam menu
            const resetProfileButton = document.createElement('button');
            resetProfileButton.id = 'resetProfileButton';
            resetProfileButton.textContent = 'Reset Profile';
            resetProfileButton.addEventListener('click', () => {
                if (confirm('Reset profile to defaults?')) {
                    localStorage.removeItem('steamCloneProfile');
                    location.reload(); // Reload to apply default profile
                }
            });
            steamDropdownMenu.appendChild(resetProfileButton);

            const bottomDownloadSummary = document.getElementById('bottomDownloadSummary');
            const idleStatus = document.getElementById('idleStatus');
            const bottomDownloadPercentage = document.getElementById('bottomDownloadPercentage');
            const bottomDownloadProgressFill = document.getElementById('bottomDownloadProgressFill');
            const torrentDetailsPanel = document.getElementById('torrentDetailsPanel');

            // Show info panel on hover
            bottomDownloadSummary.addEventListener('mouseenter', () => {
                torrentDetailsPanel.classList.remove('hidden');
            });
            bottomDownloadSummary.addEventListener('mouseleave', () => {
                torrentDetailsPanel.classList.add('hidden');
            });

        });

        function handlePlayButtonClick(gameId) {
            // Normalize gameId to string
            const normalizedGameId = gameId.toString();
            // Search the game by converting its id to string
            const game = allGamesData.find(g => g.id.toString() === normalizedGameId);
            if (!game) {
                console.error('[Renderer] Game data not found for ID:', gameId);
                return;
            }
            console.log('[Renderer] Launching game:', game.name);
            window.electronAPI.launchGame(normalizedGameId)
                .then(result => {
                    if (!result.success) {
                        console.error('[Renderer] Launch failed:', result.message);
                    }
                })
                .catch(err => {
                    console.error('[Renderer] Launch error:', err);
                });
        }

    </script>

</body>
</html>